<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Tributário Inteligente: Aluguel | Holding</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        /* Oculta o body inicialmente se for link do cliente para evitar piscar o dashboard */
        body.is-loading-client { 
            visibility: hidden;
            overflow: hidden;
        }

        /* Estilo do Loader de Inicialização */
        #initial-client-loader {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        .loader-logo {
            width: 80px;
            height: 80px;
            background: #2563eb;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }

        .loader-progress-bg {
            width: 200px;
            height: 4px;
            background: #f1f5f9;
            border-radius: 10px;
            overflow: hidden;
        }

        .loader-progress-bar {
            width: 30%;
            height: 100%;
            background: #2563eb;
            border-radius: 10px;
            animation: progress-move 2s infinite ease-in-out;
        }

        @keyframes progress-move {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        :root {
            --primary-color: #2563eb;
            --sidebar-width: 320px;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            color: #334155; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Utilitários de UI */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
        .input-field { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .input-field:focus { box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); border-color: #3b82f6; outline: none; }
        
        /* Badges */
        .scenario-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; }
        .badge-rural { background-color: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .badge-aluguel { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .badge-holding { background-color: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }

        /* Tabelas - CSS Corrigido para Cabeçalho e Colunas Fixas e Rolagem em Duas Vias */
        .table-sticky-header { border-collapse: separate; border-spacing: 0; width: 100%; }
        .table-sticky-header th { 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            background-color: #f8fafc; /* Tailwind slate-50 */ 
            border-bottom: 2px solid #e2e8f0; 
        }
        .col-sticky-left { 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background-color: #ffffff; /* Fundo sólido indispensável */
        }
        .table-sticky-header th.col-sticky-left { 
            z-index: 30; /* Fica acima da linha horizontal e da coluna vertical! */
            background-color: #f8fafc; 
        }
        .table-detailed th, .table-detailed td { white-space: nowrap; padding: 10px 14px; font-size: 0.75rem; }
        
        /* Ajustes Responsivos para Mobile */
        @media (max-width: 768px) {
            .table-detailed th, .table-detailed td { padding: 8px 10px; font-size: 0.7rem; }
            .view-section { padding-left: 1rem; padding-right: 1rem; }
            .card-grid { grid-template-columns: 1fr !important; }
            #mobileHeader { display: flex !important; }
            main { padding-top: 70px !important; }
            .col-sticky-left { position: static !important; } /* No mobile simplifica a tabela para evitar bugs de scroll */
            .table-sticky-header th { position: static !important; }
        }

        /* Cursor pointer for clickable rows */
        .cursor-pointer-row { cursor: pointer; }

        /* Abas */
        .nav-tab { cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; position: relative; }
        .nav-tab:hover { color: #1e293b; }
        .nav-tab.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        
        /* Sidebar Mobile Transition */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        
        /* Animation */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #2563eb;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #2563eb;
        }
        
        /* Month Selector Style */
        .month-selector-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .month-selector-item.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* HTML Detalhes (Accordion) Estilização nativa suave */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Loader Overlay para API */
        .api-loader {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.8);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .api-loader.hidden { display: none; }

        /* Print Styles Melhorado para quebra de página e tabelas expandidas */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm 10mm 10mm 10mm;
            }

            /* Esconde elementos indesejados */
            aside, header, #sidebarOverlay, .nav-tab-container, .no-print, .api-loader, #clientFloatingButtons { 
                display: none !important; 
            }
            
            /* Remove limitações de scroll e altura para mostrar tudo */
            body, main, #mainScroll { 
                height: auto !important; 
                width: 100% !important; 
                overflow: visible !important; 
                margin: 0 !important; 
                padding: 0 !important;
                position: static !important;
                background: white !important;
            }

            .view-section {
                overflow: visible !important; 
                height: auto !important;
                display: block !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }

            .hidden {
                display: none !important;
            }

            /* Força os containeres de tabela a quebrarem o layout fixo */
            .overflow-auto, .overflow-y-auto, .overflow-x-auto, .max-h-[600px] {
                overflow: visible !important;
                max-height: none !important;
                height: auto !important;
            }

            /* Remove os comportamentos de 'sticky' no cabeçalho durante a impressão */
            .table-sticky-header th, .col-sticky-left { 
                position: static !important; 
                background-color: white !important;
                border-bottom: 1px solid #e2e8f0 !important;
            }
            
            /* Comportamento de quebra de página para tabelas e containers */
            table { 
                page-break-inside: auto !important; 
                width: 100% !important; 
                border-collapse: collapse !important;
                table-layout: auto !important;
            }
            
            thead { 
                display: table-header-group !important; /* Repete cabeçalho */
            }
            
            tr { 
                page-break-inside: avoid !important; 
                page-break-after: auto !important; 
            }

            /* Evita que gráficos e blocos importantes sejam cortados */
            canvas, .h-64, .h-80, .grid, .bg-emerald-50, .bg-slate-50 {
                page-break-inside: avoid !important;
                margin-bottom: 10px;
            }
            
            .print-break { page-break-before: always !important; }
            .print-avoid-break { page-break-inside: avoid !important; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm">
    <!-- Script de Bloqueio Imediato para Modo Cliente -->
    <script>
        (function() {
            const params = new URLSearchParams(window.location.search);
            if(params.get('view') === 'client') {
                document.body.classList.add('is-loading-client');
                const loaderHtml = `
                    <div id="initial-client-loader">
                        <div class="loader-logo">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <p class="text-slate-600 font-bold mb-4 tracking-tight">Preparando Apresentação...</p>
                        <div class="loader-progress-bg">
                            <div class="loader-progress-bar"></div>
                        </div>
                    </div>
                `;
                document.write(loaderHtml);
            }
        })();
    </script>

    <header class="md:hidden fixed top-0 w-full bg-white border-b border-slate-200 z-50 flex items-center justify-between p-4 shadow-sm" id="mobileHeader">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-scale-balanced text-blue-600 text-lg"></i>
            <h1 class="font-bold text-slate-800">Simulador Tributário</h1>
        </div>
        <button id="mobileMenuBtn" class="text-slate-600 p-2 rounded-lg hover:bg-slate-100 focus:outline-none">
            <i class="fa-solid fa-bars text-xl"></i>
        </button>
    </header>

    <div id="sidebarOverlay" class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden glass-panel" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-white border-r border-slate-200 flex flex-col shadow-xl z-50 transform -translate-x-full md:translate-x-0 md:relative sidebar-transition">
        <div class="p-5 border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-scale-balanced text-blue-600"></i>
                    Planejamento
                </h1>
                <p class="text-xs text-slate-400">Comparativo Inteligente</p>
            </div>
            <button class="md:hidden text-slate-400 hover:text-red-500" onclick="toggleSidebar()">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto pb-5 space-y-6 relative">
            
            <div id="cloudLoader" class="api-loader hidden flex-col">
                <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-600 mb-2"></i>
                <span class="text-xs font-bold text-slate-600 mt-2" id="cloudLoaderText">Processando...</span>
            </div>

            <div class="px-5 pt-4">
                <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider"><i class="fa-solid fa-user-tie text-blue-500 mr-1"></i> Cliente / Empresa</label>
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <input type="text" id="inputClientName" placeholder="Digite o nome..." class="input-field w-full px-3 py-2 text-sm rounded-lg font-bold text-slate-700 bg-blue-50/50 border-blue-200 focus:border-blue-500" oninput="updateDashboard()">
                        <i class="fa-solid fa-pen absolute right-3 top-2.5 text-blue-400 text-xs"></i>
                    </div>
                    <button onclick="createNewClient()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg shadow-sm transition border border-slate-200" title="Criar Novo Cliente (Limpar Tudo)">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

            <div class="px-5 space-y-6">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-money-bill-wave text-emerald-600"></i> Parâmetros de Receita
                    </h3>

                    <div class="space-y-4">
                        <div class="flex rounded-lg shadow-sm bg-slate-200 p-1" role="group">
                            <button type="button" onclick="setRevenueMode('fixed')" id="btnRevFixed" class="flex-1 py-1.5 text-xs font-bold rounded-md transition duration-200 bg-white text-emerald-600 shadow-sm ring-1 ring-emerald-100">Valor Fixo</button>
                            <button type="button" onclick="setRevenueMode('detailed')" id="btnRevDetailed" class="flex-1 py-1.5 text-xs font-bold rounded-md transition duration-200 text-slate-500 hover:text-slate-700">Mês a Mês</button>
                        </div>
                        <input type="hidden" id="inputRevenueMode" value="fixed">

                        <div id="containerRevFixed" class="animate-fadeIn">
                            <label class="block text-xs font-medium text-slate-600 mb-1" id="labelMonthlyRevenue">Valor Fixo Mensal (R$)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-slate-400">R$</span>
                                <input type="text" id="inputMonthlyRevenue" value="15.000,00" inputmode="decimal" class="input-field w-full pl-8 pr-3 py-1.5 rounded-lg text-right font-medium dynamic-money" oninput="updateDashboard()">
                            </div>
                            <p class="text-[9px] text-slate-400 mt-1 italic">Este valor será computado igualmente em todos os meses.</p>
                        </div>

                        <div id="containerRevDetailed" class="hidden animate-fadeIn space-y-2">
                            <label class="block text-xs font-medium text-slate-600 mb-1">Faturamento Base por Mês (R$)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">JAN</span><input type="text" id="inputMonthVal1" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">FEV</span><input type="text" id="inputMonthVal2" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">MAR</span><input type="text" id="inputMonthVal3" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">ABR</span><input type="text" id="inputMonthVal4" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">MAI</span><input type="text" id="inputMonthVal5" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">JUN</span><input type="text" id="inputMonthVal6" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">JUL</span><input type="text" id="inputMonthVal7" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">AGO</span><input type="text" id="inputMonthVal8" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">SET</span><input type="text" id="inputMonthVal9" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">OUT</span><input type="text" id="inputMonthVal10" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">NOV</span><input type="text" id="inputMonthVal11" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                                <div class="flex items-center border border-slate-200 rounded-lg overflow-hidden bg-white focus-within:ring-2 focus-within:ring-blue-100 transition-all shadow-sm"><span class="bg-slate-50 text-[10px] font-bold text-slate-500 px-2 py-1.5 border-r border-slate-200 w-10 text-center">DEZ</span><input type="text" id="inputMonthVal12" value="0,00" class="w-full text-right text-xs px-2 py-1.5 outline-none dynamic-money" oninput="updateDashboard()"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hidden" id="legacy-rural-inputs">
                    <input type="hidden" id="inputUnitType" value="kg">
                    <input type="text" id="inputPrice" value="2,22">
                    <input type="text" id="inputYield" value="12,0">
                    <input type="text" id="inputArea" value="194,5">
                    <input type="checkbox" id="chkIcmsExempt">
                    <input type="checkbox" id="chkDistributeRevenue" checked>
                    <input type="text" id="displayCalculatedRevenue">
                    <input type="hidden" id="inputRevenue" value="0"> 
                    <div class="grid grid-cols-6 gap-1 mb-1">
                        <div onclick="toggleMonth(1)" id="month-1" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">JAN</div>
                        <div onclick="toggleMonth(2)" id="month-2" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">FEV</div>
                        <div onclick="toggleMonth(3)" id="month-3" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">MAR</div>
                        <div onclick="toggleMonth(4)" id="month-4" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">ABR</div>
                        <div onclick="toggleMonth(5)" id="month-5" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">MAI</div>
                        <div onclick="toggleMonth(6)" id="month-6" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">JUN</div>
                        <div onclick="toggleMonth(7)" id="month-7" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">JUL</div>
                        <div onclick="toggleMonth(8)" id="month-8" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">AGO</div>
                        <div onclick="toggleMonth(9)" id="month-9" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">SET</div>
                        <div onclick="toggleMonth(10)" id="month-10" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">OUT</div>
                        <div onclick="toggleMonth(11)" id="month-11" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">NOV</div>
                        <div onclick="toggleMonth(12)" id="month-12" class="month-selector-item active border border-slate-200 rounded text-center py-1 text-[10px] font-bold text-slate-500 hover:bg-slate-100">DEZ</div>
                    </div>
                </div>

                <div class="space-y-4">
                     <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">
                        <i class="fa-solid fa-chart-line text-blue-500 mr-1"></i> Parâmetros de Projeção
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Acréscimo Anual</label>
                            <div class="relative">
                                <input type="text" id="inputGrowth" value="5,00" inputmode="decimal" class="input-field w-full pl-2 pr-7 py-2 rounded-lg text-right font-mono dynamic-percent" oninput="updateDashboard()">
                                <span class="absolute right-3 top-2 text-slate-400 font-bold">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Período (Anos)</label>
                            <input type="number" id="inputYears" value="5" min="1" max="20" class="input-field w-full px-3 py-2 rounded-lg text-center font-mono" onchange="handleYearChange()">
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-200 pt-4">
                    <button onclick="openIrpfConfigModal()" class="w-full py-2 px-4 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition flex justify-center items-center gap-2 shadow-sm text-xs font-bold uppercase tracking-wide border border-blue-200">
                        <i class="fa-solid fa-table-list"></i> Configurar Tabela IRPF
                    </button>
                </div>

                <div class="pt-4 space-y-2 border-t border-slate-200 mt-4">
                    
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                        <i class="fa-solid fa-share-nodes text-emerald-600"></i> Enviar p/ Cliente
                    </h3>
                    
                    <button onclick="exportInteractiveHTML()" class="w-full py-2.5 px-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white rounded-lg transition flex justify-center items-center gap-2 shadow-md text-[11px] font-bold uppercase tracking-wide border border-emerald-700">
                        <i class="fa-solid fa-file-code"></i> Arquivo do Relatório (.HTML)
                    </button>
                    
                    <button onclick="generateShareableLink()" class="w-full py-2 px-4 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-lg transition flex justify-center items-center gap-2 shadow-sm text-[10px] font-bold uppercase tracking-wide">
                        <i class="fa-solid fa-link"></i> Gerar Link Web (Exige Hospedagem)
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2 pt-2 border-t border-slate-100 mt-2">
                        <button onclick="saveToCloud()" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex justify-center items-center gap-2 shadow-sm text-[10px] font-bold uppercase tracking-wide">
                            <i class="fa-solid fa-cloud-arrow-up"></i> Salvar Nuvem
                        </button>
                        <button onclick="openCloudLoadModal()" class="w-full py-2 px-4 bg-white hover:bg-slate-50 text-slate-800 rounded-lg transition flex justify-center items-center gap-2 shadow-sm text-[10px] font-bold uppercase tracking-wide border border-slate-300">
                            <i class="fa-solid fa-cloud-arrow-down"></i> Ver Nuvem
                        </button>
                    </div>
                </div>

                <div class="border-t border-slate-200 pt-4 mt-4">
                    <details class="group">
                        <summary class="flex justify-between items-center cursor-pointer list-none text-xs font-bold text-slate-500 uppercase tracking-wider hover:text-blue-600 transition">
                            <span><i class="fa-solid fa-sliders mr-1"></i> Valores Iniciais (Base)</span>
                            <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                        </summary>
                        <div class="text-slate-500 mt-3 space-y-4 animate-fadeIn">
                            
                            <div class="hidden p-3 bg-green-50/50 rounded-lg border border-green-100">
                                <div class="text-[10px] font-bold text-green-800 mb-2 uppercase">Rural (Pessoa Física)</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="text-[9px] block mb-1">ICMS (Se não isento)</label>
                                        <input type="text" id="taxICMS" value="19,00" class="input-field w-full p-1.5 text-xs text-right bg-white rounded dynamic-percent" oninput="updateDashboard()">
                                    </div>
                                    <div>
                                        <label class="text-[9px] block mb-1">CBS</label>
                                        <input type="text" id="taxCBS" value="8,40" class="input-field w-full p-1.5 text-xs text-right bg-white rounded dynamic-percent" oninput="updateDashboard()">
                                    </div>
                                    <div>
                                        <label class="text-[9px] block mb-1">Funrural</label>
                                        <input type="text" id="taxFunrural" value="1,50" class="input-field w-full p-1.5 text-xs text-right bg-white rounded dynamic-percent" oninput="updateDashboard()">
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-blue-50/50 rounded-lg border border-blue-100">
                                 <div class="text-[10px] font-bold text-blue-800 mb-2 uppercase">Holding (Lucro Presumido)</div>
                                 <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label class="text-[9px] block mb-1">PIS/COFINS</label>
                                        <input type="text" id="taxPisCofins" value="3,65" class="input-field w-full p-1.5 text-xs text-right bg-white rounded dynamic-percent" oninput="updateDashboard()">
                                    </div>
                                    <div>
                                        <label class="text-[9px] block mb-1">Base Presunção</label>
                                        <input type="text" id="taxPresumedBase" value="32,00" class="input-field w-full p-1.5 text-xs text-right bg-white rounded dynamic-percent" oninput="updateDashboard()">
                                    </div>
                                 </div>
                                 <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-[9px] block mb-1">IRPJ</label>
                                        <input type="text" id="taxIRPJ" value="15,00" class="input-field w-full p-1.5 text-xs text-right bg-white rounded dynamic-percent" oninput="updateDashboard()">
                                    </div>
                                    <div>
                                        <label class="text-[9px] block mb-1">CSLL</label>
                                        <input type="text" id="taxCSLL" value="9,00" class="input-field w-full p-1.5 text-xs text-right bg-white rounded dynamic-percent" oninput="updateDashboard()">
                                    </div>
                                 </div>
                            </div>

                        </div>
                    </details>
                </div>

            </div>
        </div>

        <div class="p-4 border-t border-slate-200 bg-slate-50 flex flex-col gap-2" id="sidebarFooterBtns">
            <button onclick="exportToExcel()" class="w-full py-2.5 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex justify-center items-center gap-2 shadow-sm text-xs font-semibold uppercase tracking-wide">
                <i class="fa-solid fa-file-excel"></i> Exportar Excel
            </button>
            <button onclick="exportToJson()" class="w-full py-2.5 px-4 bg-slate-800 hover:bg-slate-900 text-white rounded-lg transition flex justify-center items-center gap-2 shadow-sm text-xs font-semibold uppercase tracking-wide no-print">
                <i class="fa-solid fa-floppy-disk"></i> Salvar Backup PC
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden w-full relative pt-16 md:pt-0" id="mainContainer">
        
        <div class="bg-white border-b border-slate-200 px-4 md:px-8 pt-4 flex-shrink-0 shadow-sm z-10 nav-tab-container" id="navTabs">
            <div class="flex space-x-6 overflow-x-auto scrollbar-hide">
                <div class="nav-tab active pb-3 text-sm whitespace-nowrap" onclick="switchTab('consolidated', this)">
                    <i class="fa-solid fa-chart-pie mr-1.5"></i> Dashboard
                </div>
                <div class="nav-tab pb-3 text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap" onclick="switchTab('aluguel', this)">
                    <i class="fa-solid fa-building-user mr-1.5"></i> Módulo Aluguel PF
                </div>
                <div class="nav-tab pb-3 text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap" onclick="switchTab('holding', this)">
                    <i class="fa-solid fa-building mr-1.5"></i> Módulo Holding PJ
                </div>
                <div class="nav-tab pb-3 text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap" onclick="switchTab('report', this)">
                    <i class="fa-solid fa-file-invoice mr-1.5"></i> Relatório Cliente
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-100 p-4 md:p-8 relative scroll-smooth print-container" id="mainScroll">
            
            <div id="view-consolidated" class="view-section max-w-7xl mx-auto">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    
                    <div class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative overflow-hidden transition hover:shadow-md border-l-4 border-l-green-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="scenario-badge badge-rural mb-1 inline-block">Cenário Rural</span>
                                <h3 class="font-bold text-slate-700 text-lg">Produtor Rural PF</h3>
                            </div>
                            <div class="bg-green-100 text-green-600 w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-wheat-awn"></i>
                            </div>
                        </div>
                        <div class="space-y-1 mb-4">
                            <p class="text-xs text-slate-500 uppercase font-semibold">Total de Impostos Estimados</p>
                            <p class="text-2xl font-bold text-red-600 tracking-tight" id="valTaxRural">R$ 0,00</p>
                        </div>
                        <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                            <span class="text-xs text-slate-500">Carga Tributária Efetiva</span>
                            <span class="text-sm font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded" id="taxRateRural">0%</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative overflow-hidden transition hover:shadow-md border-l-4 border-l-red-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="scenario-badge badge-aluguel mb-1 inline-block">Cenário 1</span>
                                <h3 class="font-bold text-slate-700 text-lg">Aluguel PF</h3>
                            </div>
                            <div class="bg-red-100 text-red-600 w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-house-user"></i>
                            </div>
                        </div>
                        <div class="space-y-1 mb-4">
                            <p class="text-xs text-slate-500 uppercase font-semibold">Total de Impostos Estimados</p>
                            <p class="text-2xl font-bold text-red-600 tracking-tight" id="valTaxAluguel">R$ 0,00</p>
                        </div>
                         <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                            <span class="text-xs text-slate-500">Carga Tributária Efetiva</span>
                            <span class="text-sm font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded" id="taxRateAluguel">0%</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-md border border-blue-200 p-6 relative overflow-hidden transition hover:shadow-lg border-l-4 border-l-blue-600 ring-1 ring-blue-100">
                        <div class="absolute top-0 right-0 bg-blue-600 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">RECOMENDADO</div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="scenario-badge badge-holding mb-1 inline-block">Cenário 2</span>
                                <h3 class="font-bold text-slate-800 text-lg">Holding (PJ)</h3>
                            </div>
                            <div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center shadow-sm">
                                <i class="fa-solid fa-building-columns"></i>
                            </div>
                        </div>
                        <div class="space-y-1 mb-4">
                            <p class="text-xs text-slate-500 uppercase font-semibold">Total de Impostos Estimados</p>
                            <p class="text-3xl font-bold text-red-600 tracking-tight" id="valTaxHolding">R$ 0,00</p>
                        </div>
                         <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                            <span class="text-xs text-slate-500">Carga Tributária Efetiva</span>
                            <span class="text-sm font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded" id="taxRateHolding">0%</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6 mb-8 print-break">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700"><i class="fa-solid fa-chart-line text-blue-500 mr-2"></i>Comparativo de Carga Tributária Anual (%)</h3>
                            <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Evolução %</span>
                        </div>
                        <div class="h-64 md:h-80 w-full relative">
                            <canvas id="chartWealth"></canvas> 
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-12">
                    <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-2">
                        <h3 class="font-bold text-slate-800"><i class="fa-solid fa-list-ol mr-2 text-slate-400"></i>Resumo Anual de Tributos</h3>
                        <div class="text-xs text-slate-500 flex items-center gap-1 no-print">
                            <i class="fa-solid fa-hand-pointer animate-pulse"></i> Deslize para ver mais
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-detailed" id="annualTable">
                            </table>
                    </div>
                </div>
            </div>

            <div id="view-rural" class="hidden view-section max-w-7xl mx-auto space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-4"><i class="fa-solid fa-chart-line text-green-500 mr-2"></i>Evolução Tributária Rural</h3>
                    <div class="h-80 w-full">
                        <canvas id="chartRuralEvolution"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50">
                        <h3 class="font-bold text-slate-700 text-sm">Configuração de Alíquotas Rural</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead id="ruralRatesHeader"></thead>
                            <tbody id="ruralRatesBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="ruralAnnualReportBody"></div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-green-50/50">
                        <h3 class="font-bold text-green-800 text-sm">Fluxo de Caixa Mensal Rural</h3>
                    </div>
                    <div class="overflow-auto max-h-[600px]">
                        <table class="w-full text-xs text-left table-sticky-header">
                            <thead class="bg-white border-b-2 border-slate-200">
                                <tr>
                                    <th class="px-4 py-3 col-sticky-left bg-white shadow-sm border-r border-slate-100">Mês/Ano</th>
                                    <th class="px-4 py-3 text-right bg-slate-50 border-r border-slate-100">Faturamento</th>
                                    <th class="px-4 py-2 text-right border-r border-slate-50">ICMS</th>
                                    <th class="px-4 py-2 text-right border-r border-slate-50">CBS</th>
                                    <th class="px-4 py-2 text-right border-r border-slate-50">IBS</th>
                                    <th class="px-4 py-2 text-right border-r border-slate-50">Funrural</th>
                                    <th class="px-4 py-3 text-right font-bold text-red-700 bg-red-50/80">Total Imp.</th>
                                </tr>
                            </thead>
                            <tbody id="ruralMonthlyBody" class="divide-y divide-slate-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>

             <div id="view-aluguel" class="view-section hidden max-w-7xl mx-auto space-y-6 print-break">
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 flex items-start gap-3">
                    <i class="fa-solid fa-circle-exclamation text-red-600 mt-0.5"></i>
                    <div>
                        <h3 class="text-sm font-bold text-red-800">Aluguel PF: IRPF Carnê-Leão & Reforma</h3>
                        <p class="text-xs text-red-700 mt-1">Cálculo direto sem deduções. Transição com alíquotas de IBS e CBS para PF.</p>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm"><i class="fa-solid fa-chart-column text-red-500 mr-2"></i>Evolução Detalhada da Carga Tributária (Aluguel PF)</h3>
                         <div class="flex bg-slate-100 p-0.5 rounded-lg no-print">
                            <button onclick="setChartMode('aluguel', 'value')" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-600 hover:text-slate-800" id="btnAluguelVal">Valores (R$)</button>
                            <button onclick="setChartMode('aluguel', 'percent')" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-400 hover:text-slate-600" id="btnAluguelPerc">Carga (%)</button>
                         </div>
                    </div>
                    <div class="h-60 w-full relative">
                        <canvas id="chartAluguelEvolution"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 cursor-pointer hover:bg-slate-100 transition no-print" onclick="toggleConfig('aluguelConfigBody', 'aluguelConfigIcon')">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-sliders text-red-500 mr-2"></i>Configuração Anual de Alíquotas</h3>
                         <i id="aluguelConfigIcon" class="fa-solid fa-chevron-down text-slate-400 transition-transform duration-300"></i>
                    </div>
                    <div id="aluguelConfigBody" class="overflow-x-auto p-4 transition-all duration-300">
                         <table class="w-full text-xs text-left">
                            <thead><tr id="aluguelRatesHeader"><th class="p-2 border-b">Parâmetro</th></tr></thead>
                            <tbody id="aluguelRatesBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print-break">
                    <div class="p-4 border-b border-slate-100 bg-red-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-red-800 text-sm"><i class="fa-solid fa-calendar-days text-red-600 mr-2"></i>Fluxo de Caixa Mensal Detalhado</h3>
                        <span class="text-[10px] font-semibold text-red-600 bg-red-100 px-2 py-1 rounded-full animate-pulse no-print"><i class="fa-solid fa-hand-pointer mr-1"></i>Clique nas linhas para detalhes</span>
                    </div>
                    <div class="overflow-auto max-h-[600px] print-table-container">
                        <table class="w-full text-xs text-left table-sticky-header">
                            <thead class="bg-white border-b-2 border-slate-200 text-slate-600">
                                <tr>
                                    <th class="px-4 py-3 col-sticky-left bg-white shadow-sm border-r border-slate-100">Mês/Ano</th>
                                    <th class="px-4 py-3 text-right bg-slate-50 border-r border-slate-100">Receita Bruta</th>
                                    <th class="px-4 py-3 text-right font-medium text-blue-600 border-r border-slate-100">IRPF (Carnê)</th>
                                    <th class="px-4 py-3 text-right text-orange-600 border-r border-slate-100">IBS</th>
                                    <th class="px-4 py-3 text-right text-orange-600 border-r border-slate-100">CBS</th>
                                    <th class="px-4 py-3 text-right font-bold text-red-700 bg-red-50/80">Total Imp.</th>
                                </tr>
                            </thead>
                            <tbody id="aluguelMonthlyBody" class="divide-y divide-slate-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-holding" class="view-section hidden max-w-7xl mx-auto space-y-6 print-break">
                 <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm"><i class="fa-solid fa-chart-column text-blue-500 mr-2"></i>Evolução Detalhada da Carga Tributária (Holding PJ)</h3>
                         <div class="flex bg-slate-100 p-0.5 rounded-lg no-print">
                            <button onclick="setChartMode('holding', 'value')" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-600 hover:text-slate-800" id="btnHoldingVal">Valores (R$)</button>
                            <button onclick="setChartMode('holding', 'percent')" class="px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-400 hover:text-slate-600" id="btnHoldingPerc">Carga (%)</button>
                         </div>
                    </div>
                    <div class="h-60 w-full relative">
                        <canvas id="chartHoldingEvolution"></canvas>
                    </div>
                </div>

                 <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50 flex flex-col md:flex-row justify-between md:items-center gap-2 cursor-pointer hover:bg-slate-100 transition no-print" onclick="toggleConfig('holdingConfigBody', 'holdingConfigIcon')">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-sliders text-blue-600"></i>
                            <h3 class="font-bold text-blue-800 text-sm">Ajuste Fino de Alíquotas (Ano a Ano)</h3>
                        </div>
                         <i id="holdingConfigIcon" class="fa-solid fa-chevron-down text-slate-400 transition-transform duration-300"></i>
                    </div>
                    <div id="holdingConfigBody" class="overflow-x-auto p-4 transition-all duration-300">
                        <table class="w-full text-xs text-left">
                            <thead><tr id="holdingRatesHeader"><th class="p-2 border-b">Parâmetro</th></tr></thead>
                            <tbody id="holdingRatesBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print-break">
                     <div class="p-4 border-b border-slate-100 bg-blue-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-blue-800 text-sm"><i class="fa-solid fa-calendar-days text-blue-600 mr-2"></i>Fluxo de Caixa Mensal Detalhado (IRPJ/CSLL Trimestral)</h3>
                        <span class="text-[10px] font-semibold text-blue-600 bg-blue-100 px-2 py-1 rounded-full animate-pulse no-print"><i class="fa-solid fa-hand-pointer mr-1"></i>Clique nas linhas para detalhes</span>
                    </div>
                    <div class="overflow-auto max-h-[600px] print-table-container">
                        <table class="w-full text-xs text-left table-sticky-header">
                            <thead class="bg-white border-b-2 border-slate-200 text-slate-600">
                                <tr>
                                    <th class="px-4 py-3 col-sticky-left bg-white shadow-sm border-r border-slate-100">Mês/Ano</th>
                                    <th class="px-4 py-3 text-right bg-slate-50 border-r border-slate-100">Fat. Bruto</th>
                                    <th class="px-4 py-3 text-right border-r border-slate-100">PIS/COFINS</th>
                                    <th class="px-4 py-3 text-right border-r border-slate-100 text-orange-600">IBS</th>
                                    <th class="px-4 py-3 text-right border-r border-slate-100 text-orange-600">CBS</th>
                                    <th class="px-4 py-3 text-right border-r border-slate-100 font-semibold text-blue-600">IRPJ (Trim.)</th>
                                    <th class="px-4 py-3 text-right border-r border-slate-100 font-semibold text-blue-600">Adic. (Trim.)</th>
                                    <th class="px-4 py-3 text-right border-r border-slate-100 font-semibold text-blue-600">CSLL (Trim.)</th>
                                    <th class="px-4 py-3 text-right font-bold text-red-700 bg-red-50/80">Total Imp.</th>
                                </tr>
                            </thead>
                            <tbody id="holdingMonthlyBody" class="divide-y divide-slate-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="view-report" class="view-section hidden max-w-[210mm] mx-auto bg-white px-10 py-12 shadow-xl border border-slate-200 min-h-[297mm]" style="margin-bottom: 2rem;">
                
                <div class="border-b-[3px] border-slate-800 pb-6 mb-8 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Planejamento Tributário</h1>
                        <h2 class="text-lg font-medium text-slate-500 mt-1">Comparativo de Cenários: Pessoa Física vs. Holding</h2>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-blue-800 text-xl tracking-tight">Evolução Auditoria</p>
                        <p class="text-sm text-slate-500 font-medium">Contador: Gabriel Mateus</p>
                    </div>
                </div>
                
                <div class="bg-slate-50 p-6 rounded-lg mb-8 border border-slate-200 shadow-sm">
                    <p class="text-xs text-slate-400 uppercase font-bold tracking-widest mb-1">Preparado exclusivamente para:</p>
                    <p class="text-2xl font-black text-slate-800" id="reportClientName">Cliente Não Informado</p>
                    <p class="text-sm text-slate-500 mt-2 font-mono" id="reportDate"></p>
                </div>

                <div class="mb-10 print-avoid-break" id="report-summary">
                    <h3 class="text-lg font-bold text-slate-800 border-b border-slate-200 pb-2 mb-4 flex items-center gap-2"><i class="fa-solid fa-list-check text-blue-600"></i> Resumo Executivo</h3>
                    <p class="text-slate-600 mb-6 leading-relaxed text-justify">
                        O presente estudo tem como objetivo analisar e comparar a carga tributária estimada incidente sobre as receitas auferidas no periodo projetado de <span id="reportYearsSpan" class="font-bold text-slate-800"></span> anos. 
                        Foram comparados os cálculos simulando a tributação do recebimento  de aluguel na Pessoa Física (aplicação do Carnê-Leão e demais tributos) e uma Holding Patrimonial (Pessoa Jurídica optante pelo Lucro Presumido).
                    </p>
                    <div class="grid grid-cols-3 gap-6 text-center mb-6">
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col justify-center">
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Faturamento Projetado</p>
                            <p class="text-2xl font-black text-slate-800 mt-2 whitespace-nowrap" id="reportTotalGross"></p>
                        </div>
                        <div class="p-5 bg-red-50/50 rounded-xl border border-red-200 shadow-sm overflow-hidden flex flex-col justify-center">
                            <p class="text-[10px] text-red-600 uppercase font-bold tracking-wider">Impostos (Pessoa Física)</p>
                            <p class="text-2xl font-black text-red-700 mt-2 whitespace-nowrap" id="reportTotalAluguel"></p>
                        </div>
                        <div class="p-5 bg-blue-50/50 rounded-xl border border-blue-300 shadow-sm relative overflow-hidden ring-1 ring-blue-100 flex flex-col justify-center">
                            <div class="absolute top-0 right-0 bg-blue-600 text-white text-[9px] px-2 py-0.5 rounded-bl-lg font-bold uppercase tracking-wider shadow-sm">Recomendado</div>
                            <p class="text-[10px] text-blue-700 uppercase font-bold tracking-wider">Impostos Holding (PJ)</p>
                            <p class="text-2xl font-black text-blue-800 mt-2 whitespace-nowrap" id="reportTotalHolding"></p>
                        </div>
                    </div>
                    
                    <div class="bg-emerald-50 border border-emerald-200 p-6 rounded-xl flex items-center gap-5 shadow-sm mt-4 overflow-hidden">
                        <div class="w-14 h-14 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-2xl shrink-0 shadow-inner">
                            <i class="fa-solid fa-piggy-bank"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-xs font-bold text-emerald-800 uppercase tracking-widest">Economia Tributária Líquida no Período</p>
                            <p class="text-3xl font-black text-emerald-700 tracking-tight mt-1 whitespace-nowrap" id="reportSavings"></p>
                        </div>
                    </div>
                </div>

                <div class="mb-10 print-avoid-break" id="report-charts">
                    <h3 class="text-lg font-bold text-slate-800 border-b border-slate-200 pb-2 mb-6 flex items-center gap-2"><i class="fa-solid fa-chart-line text-blue-600"></i> Comparativo de Carga Tributária Anual (%)</h3>
                    <div class="h-64 w-full">
                        <canvas id="chartReport"></canvas>
                    </div>
                </div>

                <div class="mb-10 print-avoid-break" id="report-annual-table">
                    <h3 class="text-lg font-bold text-slate-800 border-b border-slate-200 pb-2 mb-4 flex items-center gap-2"><i class="fa-solid fa-table text-blue-600"></i> Resumo da Projeção Ano a Ano</h3>
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-slate-100 border-b-2 border-slate-300 text-slate-700 uppercase text-xs tracking-wider">
                            <tr>
                                <th class="p-3 border border-slate-200">Exercício</th>
                                <th class="p-3 text-right border border-slate-200">Faturamento Bruto</th>
                                <th class="p-3 text-right border border-slate-200 text-red-800 bg-red-50/50">Imposto (PF)</th>
                                <th class="p-3 text-right border border-slate-200 text-blue-800 bg-blue-50/50">Imposto (Holding)</th>
                                <th class="p-3 text-right border border-slate-200 text-emerald-800 bg-emerald-50/50">Vantagem Financeira</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="divide-y divide-slate-200">
                            </tbody>
                    </table>
                </div>
                
                <div class="mb-10 print-break" id="report-monthly-detail">
                    <h3 class="text-lg font-bold text-slate-800 border-b border-slate-200 pb-2 mb-4 flex items-center gap-2"><i class="fa-solid fa-calendar-days text-blue-600"></i> Detalhamento Mensal do Período</h3>
                    <p class="text-xs text-slate-500 mb-3 italic">Abaixo encontra-se a demonstração detalhada do fluxo de caixa tributário mensal calculado para ambas as hipóteses (Pessoa Física e Holding PJ).</p>
                    <table class="w-full text-[10px] text-left border-collapse">
                        <thead class="bg-slate-800 text-white uppercase tracking-wider text-[9px]">
                            <tr>
                                <th class="p-2 border border-slate-700 text-center" rowspan="2">Mês/Ano</th>
                                <th class="p-2 text-right border border-slate-700" rowspan="2">Faturamento Bruto</th>
                                <th class="p-2 text-center border border-slate-700 bg-red-900/50" colspan="3">PESSOA FÍSICA (ALUGUEL)</th>
                                <th class="p-2 text-center border border-slate-700 bg-blue-900/50" colspan="4">HOLDING (PJ)</th>
                                <th class="p-2 text-right border border-slate-700 text-emerald-300" rowspan="2">Vantagem Média PF x PJ</th>
                            </tr>
                            <tr>
                                <th class="p-1.5 text-right border border-slate-700 bg-red-900/30 text-red-200">IRPF</th>
                                <th class="p-1.5 text-right border border-slate-700 bg-red-900/30 text-red-200">IBS/CBS</th>
                                <th class="p-1.5 text-right border border-slate-700 bg-red-800 font-bold">Total PF</th>
                                <th class="p-1.5 text-right border border-slate-700 bg-blue-900/30 text-blue-200">PIS/COFINS</th>
                                <th class="p-1.5 text-right border border-slate-700 bg-blue-900/30 text-blue-200">IBS/CBS</th>
                                <th class="p-1.5 text-right border border-slate-700 bg-blue-900/30 text-blue-200">IRPJ/CSLL</th>
                                <th class="p-1.5 text-right border border-slate-700 bg-blue-800 font-bold">Total PJ</th>
                            </tr>
                        </thead>
                        <tbody id="reportMonthlyDetailBody" class="divide-y divide-slate-200 text-slate-700">
                            </tbody>
                    </table>
                </div>

                <div class="mt-16 pt-8 border-t border-slate-200 text-center text-slate-500 text-sm print-avoid-break">
                    <p class="italic mb-12">Os valores apresentados são projeções estimadas baseadas nas premissas informadas e na legislação tributária vigente nesta data. Consulte sempre os relatórios contábeis oficiais para apuração exata.</p>
                    <div class="mx-auto w-72 border-t border-slate-800 pt-3">
                        <p class="font-black text-slate-800 text-base uppercase tracking-widest">Gabriel Mateus</p>
                        <p class="font-medium text-blue-800">Evolução Auditoria</p>
                    </div>
                </div>

                <div class="fixed bottom-8 right-8 flex flex-col gap-3 z-50 no-print" id="clientFloatingButtons">
                    <button onclick="generateProfessionalPDF()" class="bg-slate-800 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center hover:bg-slate-900 hover:scale-105 transition-all text-xl ring-4 ring-slate-200" title="Baixar PDF">
                        <i class="fa-solid fa-file-pdf"></i>
                    </button>
                </div>
            </div>

        </div>
    </main>

    <div id="cloudLoadModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 flex flex-col transform scale-95 transition-transform duration-300 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-cloud-arrow-down mr-2 text-blue-500"></i>Carregar da Nuvem</h2>
                <button onclick="closeCloudLoadModal()" class="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-4 max-h-96 overflow-y-auto" id="cloudClientsList">
                <div class="flex items-center justify-center py-6 text-slate-400">
                    <i class="fa-solid fa-spinner fa-spin mr-2"></i> Buscando clientes...
                </div>
            </div>
        </div>
    </div>

    <div id="monthlyReportModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl mx-4 flex flex-col h-[85vh] transform scale-95 transition-transform duration-300 overflow-hidden border border-slate-200">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/80">
                <div>
                    <h2 class="text-xl font-black text-slate-800"><i class="fa-solid fa-table-cells-large mr-3 text-blue-600"></i>Relatório Consolidado Detalhado</h2>
                    <p class="text-xs text-slate-500 mt-1 ml-8">Comparativo mensal completo de faturamento versus impostos apurados por cenário.</p>
                </div>
                <button onclick="closeMonthlyReportModal()" class="text-slate-400 hover:text-slate-600 w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 transition bg-white shadow-sm border border-slate-200">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto bg-white p-0">
                <table class="w-full text-xs text-left table-sticky-header">
                    <thead class="text-slate-600 font-bold border-b-2 border-slate-200">
                        <tr>
                            <th class="px-4 py-4 border-r border-slate-200 col-sticky-left bg-white shadow-sm uppercase tracking-wider">Mês/Ano</th>
                            <th class="px-4 py-4 text-right border-r border-slate-200 bg-slate-50 uppercase tracking-wider text-slate-700">Faturamento Bruto</th>
                            <th class="px-4 py-4 text-right border-r border-slate-200 bg-red-50 text-red-800 uppercase tracking-wider"><i class="fa-solid fa-house-user mr-1"></i> Aluguel (Impostos)</th>
                            <th class="px-4 py-4 text-right bg-blue-50 text-blue-800 uppercase tracking-wider"><i class="fa-solid fa-building mr-1"></i> Holding (Impostos)</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
            <div class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="exportToExcel()" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-bold uppercase tracking-wide transition shadow-sm flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                <button onclick="closeMonthlyReportModal()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-wide transition shadow-sm">Fechar Relatório</button>
            </div>
        </div>
    </div>

    <div id="detailMonthModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/70 backdrop-blur-md hidden opacity-0 transition-opacity duration-300">
        <div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col h-[90vh] md:h-auto md:max-h-[90vh] transform scale-95 transition-transform duration-300 overflow-hidden border border-slate-200/50">
            <div class="p-6 border-b border-slate-200/80 flex justify-between items-start bg-white z-10 shadow-sm relative">
                <div class="flex items-start gap-4">
                    <div id="detailModalIcon" class="w-12 h-12 rounded-xl flex items-center justify-center text-white bg-blue-600 shadow-md text-xl">
                        <i class="fa-solid fa-calculator"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-slate-800 tracking-tight" id="detailModalTitle">Memória de Cálculo</h2>
                        <div class="flex items-center gap-2 mt-1.5">
                            <span class="bg-slate-100 border border-slate-200 text-slate-600 text-[11px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wide" id="detailModalSubtitle">Competência: 01/2026</span>
                            <span class="bg-green-100 border border-green-200 text-green-700 text-[11px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wide" id="detailModalGross">Fat: R$ 0,00</span>
                        </div>
                    </div>
                </div>
                <button onclick="closeDetailModal()" class="text-slate-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition bg-slate-50 border border-slate-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-auto p-6 bg-slate-100/50 scroll-smooth">
                <div id="detailModalContent">
                    </div>
            </div>
            
            <div class="p-5 border-t border-slate-200/80 bg-white flex justify-end z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] relative">
                <button onclick="closeDetailModal()" class="px-8 py-2.5 bg-slate-800 hover:bg-slate-900 text-white rounded-xl text-xs font-bold uppercase tracking-wider transition shadow-lg shadow-slate-900/20">Fechar Detalhamento</button>
            </div>
        </div>
    </div>

    <div id="irpfConfigModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 flex flex-col h-[90vh] transform scale-95 transition-transform duration-300 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-table-list mr-2 text-blue-500"></i>Configurar Tabela Progressiva IRPF</h2>
                <button onclick="closeIrpfConfigModal()" class="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto bg-slate-50 p-6 space-y-6">
                
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center"><i class="fa-solid fa-calendar-days mr-2 text-blue-500"></i>Tabela Mensal (Carnê-Leão)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left" id="tableIrpfMonthly">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200">
                                    <th class="p-2">Base de Cálculo (Até R$)</th>
                                    <th class="p-2">Alíquota (%)</th>
                                    <th class="p-2">Dedução (R$)</th>
                                </tr>
                            </thead>
                            <tbody id="bodyIrpfMonthly">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center"><i class="fa-solid fa-calendar-check mr-2 text-green-500"></i>Tabela Anual (Ajuste)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left" id="tableIrpfAnnual">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200">
                                    <th class="p-2">Base de Cálculo (Até R$)</th>
                                    <th class="p-2">Alíquota (%)</th>
                                    <th class="p-2">Dedução (R$)</th>
                                </tr>
                            </thead>
                            <tbody id="bodyIrpfAnnual">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <div class="p-4 border-t border-slate-100 bg-white flex justify-end gap-3">
                <button onclick="resetIrpfTables()" class="px-4 py-2 text-slate-500 hover:text-slate-700 text-xs font-semibold uppercase">Restaurar Padrão</button>
                <button onclick="closeIrpfConfigModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold uppercase tracking-wide transition shadow-sm">Aplicar & Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // === VARIÁVEL DA NUVEM (Google Apps Script) ===
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx4bWp6Ts4zmmJJgubChZWr67ldM09vefRgrQ1Xp_Ch1Zs99SsVAm8QBOIAAjWC1PC6/exec";

        // --- UI UTILS & NAVIGATION ---
        const startYear = 2026; 
        let annualRates = {}; 
        let chartWealthInstance = null;
        let chartTaxesInstance = null;
        let chartAnnualSummaryInstance = null;
        let chartRuralEvolutionInstance = null;
        let chartAluguelEvolutionInstance = null;
        let chartHoldingEvolutionInstance = null;
        let chartReportInstance = null; 
        let debounceTimer;
        let globalCalculationData = null;
        let chartViewModes = { rural: 'value', aluguel: 'value', holding: 'value' };
        let chartAnnualSummaryMode = 'value';
        let isClientViewMode = false; // Flag para o modo Link do Cliente

        // Dados globais para tabelas progressivas (configuráveis)
        let irpfTables = {
            monthly: [
                { limit: 2259.20, rate: 0, ded: 0 },
                { limit: 2826.65, rate: 7.5, ded: 169.44 },
                { limit: 3751.05, rate: 15.0, ded: 381.44 },
                { limit: 4664.68, rate: 22.5, ded: 662.77 },
                { limit: 999999999, rate: 27.5, ded: 896.00 }
            ],
            annual: [
                { limit: 27110.40, rate: 0, ded: 0 },
                { limit: 33919.80, rate: 7.5, ded: 2033.28 },
                { limit: 45012.60, rate: 15.0, ded: 4577.28 },
                { limit: 55976.16, rate: 22.5, ded: 7953.24 },
                { limit: 999999999, rate: 27.5, ded: 10752.00 }
            ]
        };

        const defaultIrpfTables = JSON.parse(JSON.stringify(irpfTables)); 

        // Toggle Sidebar Mobile
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const menuBtn = document.getElementById('mobileMenuBtn');

        if (menuBtn) {
            menuBtn.addEventListener('click', toggleSidebar);
        }

        function toggleSidebar() {
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }
        
        // Fechar sidebar ao clicar em um item de navegação no mobile
        function closeSidebarOnMobile() {
            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        }

        function toggleConfig(elementId, iconId) {
            const element = document.getElementById(elementId);
            const icon = document.getElementById(iconId);
            
            if (element.classList.contains('hidden')) {
                element.classList.remove('hidden');
                icon.classList.remove('-rotate-90');
                icon.classList.add('rotate-0');
            } else {
                element.classList.add('hidden');
                icon.classList.remove('rotate-0');
                icon.classList.add('-rotate-90');
            }
        }

        function setRevenueMode(mode) {
            document.getElementById('inputRevenueMode').value = mode;
            const btnFixed = document.getElementById('btnRevFixed');
            const btnDetailed = document.getElementById('btnRevDetailed');
            const contFixed = document.getElementById('containerRevFixed');
            const contDetailed = document.getElementById('containerRevDetailed');

            if (mode === 'fixed') {
                btnFixed.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition duration-200 bg-white text-emerald-600 shadow-sm ring-1 ring-emerald-100";
                btnDetailed.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition duration-200 text-slate-500 hover:text-slate-700";
                contFixed.classList.remove('hidden');
                contDetailed.classList.add('hidden');
            } else {
                btnDetailed.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition duration-200 bg-white text-emerald-600 shadow-sm ring-1 ring-emerald-100";
                btnFixed.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition duration-200 text-slate-500 hover:text-slate-700";
                contDetailed.classList.remove('hidden');
                contFixed.classList.add('hidden');
            }
            updateDashboard();
        }

        function toggleMonth(monthIndex) {
            const el = document.getElementById(`month-${monthIndex}`);
            el.classList.toggle('active');
            updateDashboard();
        }

        function toggleAllMonths() {
            const allActive = document.querySelectorAll('.month-selector-item.active').length === 12;
            for(let i=1; i<=12; i++) {
                const el = document.getElementById(`month-${i}`);
                if (allActive) el.classList.remove('active');
                else el.classList.add('active');
            }
            updateDashboard();
        }

        function getActiveMonths() {
            let active = [];
            for(let i=1; i<=12; i++) {
                if(document.getElementById(`month-${i}`).classList.contains('active')) {
                    active.push(i);
                }
            }
            return active;
        }

        function switchTab(tabId, element) {
            closeSidebarOnMobile();
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-tab').forEach(el => {
                el.classList.remove('active', 'border-blue-600', 'text-blue-600'); 
                el.classList.add('text-slate-500');
            });
            
            if(element) {
                element.classList.add('active');
                element.classList.remove('text-slate-500');
            }

            // Força atualização dos gráficos quando a aba muda para garantir que o contêiner visível permita a renderização
            if(tabId === 'report' && globalCalculationData) {
                renderClientReport(globalCalculationData);
            } else {
                // Pequeno delay para garantir que o CSS 'hidden' foi removido e o elemento tem tamanho
                setTimeout(() => {
                    updateDashboard(); 
                }, 50);
            }
            
            const mainScroll = document.getElementById('mainScroll');
            if (mainScroll) mainScroll.scrollTop = 0;
        }

        function setChartMode(module, mode) {
            chartViewModes[module] = mode;
            
            const btnVal = document.getElementById(`btn${module.charAt(0).toUpperCase() + module.slice(1)}Val`);
            const btnPerc = document.getElementById(`btn${module.charAt(0).toUpperCase() + module.slice(1)}Perc`);
            if (!btnVal || !btnPerc) return;
            
            if (mode === 'value') {
                btnVal.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors bg-white text-blue-600 shadow-sm";
                btnPerc.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-400 hover:text-slate-600";
            } else {
                btnPerc.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors bg-white text-blue-600 shadow-sm";
                btnVal.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-400 hover:text-slate-600";
            }

            updateDashboard();
        }

        function setAnnualSummaryMode(mode) {
            chartAnnualSummaryMode = mode;
            
            const btnVal = document.getElementById('btnAnnualVal');
            const btnPerc = document.getElementById('btnAnnualPerc');
            if (!btnVal || !btnPerc) return;
            
            if (mode === 'value') {
                btnVal.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors bg-white text-blue-600 shadow-sm";
                btnPerc.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-400 hover:text-slate-600";
            } else {
                btnPerc.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors bg-white text-blue-600 shadow-sm";
                btnVal.className = "px-3 py-1 text-xs font-bold rounded-md transition-colors text-slate-400 hover:text-slate-600";
            }

            updateDashboard();
        }

        // --- FORMATTING & MASKS ---
        function formatCurrency(value) {
            const val = Number(value);
            if (value === undefined || value === null || isNaN(val)) return 'R$ 0,00';
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        function formatPercent(value) {
            const val = Number(value);
            if (value === undefined || value === null || isNaN(val)) return '0,00%';
            return val.toFixed(2).replace('.', ',') + '%';
        }

        function parseMaskedValue(valueStr) {
            if(valueStr === undefined || valueStr === null || valueStr === "") return 0;
            if(typeof valueStr === 'number') return valueStr;
            
            // Remove tudo que não é dígito ou vírgula ou sinal de menos
            // Importante: remove o ponto de milhar primeiro
            let clean = valueStr.toString().replace(/\./g, ''); 
            clean = clean.replace(/[^0-9,\-]/g, ''); 
            clean = clean.replace(',', '.');
            
            const result = parseFloat(clean);
            return isNaN(result) ? 0 : result;
        }

        function applyMasks() {
            if (typeof $ !== 'undefined' && $.fn.mask) {
                $('.money-mask-simple').mask('#.##0,00', {reverse: true});
            }
        }

        function setupDynamicInputs() {
            document.querySelectorAll('.dynamic-money, .dynamic-percent, .dynamic-decimal').forEach(input => {
                if(input.dataset.hasListener) return;
                input.dataset.hasListener = "true";
                
                input.addEventListener('input', function(e) {
                    let cursorPosition = e.target.selectionStart;
                    let originalLength = e.target.value.length;

                    let val = e.target.value;
                    
                    // Tratamento específico para permitir apenas números, uma vírgula e pontos de milhar automáticos se necessário
                    // No entanto, para inputs dinâmicos sem máscara JQuery, simplificamos a higienização
                    if (e.target.classList.contains('dynamic-decimal') || e.target.classList.contains('dynamic-percent')) {
                        val = val.replace(/[^0-9,]/g, '');
                        const parts = val.split(',');
                        if (parts.length > 2) {
                            val = parts[0] + ',' + parts.slice(1).join('');
                        }
                    }

                    if (val !== e.target.value) {
                        e.target.value = val;
                        // Tenta manter a posição do cursor
                        let newPosition = cursorPosition + (val.length - originalLength);
                        e.target.setSelectionRange(newPosition, newPosition);
                    }
                });

                // Limpa o campo ao focar se for zero para facilitar a digitação no mobile
                input.addEventListener('focus', function(e) {
                    if (parseMaskedValue(e.target.value) === 0) {
                        // e.target.value = ''; // Opcional: decidir se limpa ou seleciona tudo
                        e.target.select();
                    }
                });
            });
        }

        // --- NOVO CLIENTE ---
        function createNewClient() {
            if(!confirm("Tem certeza que deseja iniciar um novo cliente? Isso limpará a tela atual.")) return;
            document.getElementById('inputClientName').value = '';
            document.getElementById('inputMonthlyRevenue').value = '15.000,00';
            for(let m=1; m<=12; m++) {
                let el = document.getElementById(`inputMonthVal${m}`);
                if(el) el.value = '0,00';
            }
            document.getElementById('inputGrowth').value = '5,00';
            document.getElementById('inputYears').value = '5';
            setRevenueMode('fixed');
            resetIrpfTables();
            annualRates = {}; 
            initAnnualRates();
            updateDashboard();
            alert('Novo formulário em branco iniciado!');
        }

        // --- GATHER DATA ---
        function getSaveData() {
            const data = {
                annualRates: annualRates,
                irpfTables: irpfTables,
                inputs: {
                    revenueMode: document.getElementById('inputRevenueMode')?.value || 'fixed',
                    monthlyRevenue: document.getElementById('inputMonthlyRevenue')?.value,
                    detailedRevenue: [],
                    growth: document.getElementById('inputGrowth').value,
                    years: document.getElementById('inputYears').value
                }
            };
            for(let m=1; m<=12; m++) {
                data.inputs.detailedRevenue[m] = document.getElementById(`inputMonthVal${m}`)?.value || "0,00";
            }
            return data;
        }

        function applyLoadedData(data) {
            annualRates = data.annualRates || {};
            irpfTables = data.irpfTables || defaultIrpfTables;
            
            if (data.inputs) {
                if(data.inputs.revenueMode) {
                    setRevenueMode(data.inputs.revenueMode);
                }
                if(data.inputs.monthlyRevenue && document.getElementById('inputMonthlyRevenue')) {
                    document.getElementById('inputMonthlyRevenue').value = data.inputs.monthlyRevenue;
                }
                if(data.inputs.detailedRevenue) {
                    for(let m=1; m<=12; m++) {
                        const el = document.getElementById(`inputMonthVal${m}`);
                        if(el && data.inputs.detailedRevenue[m]) el.value = data.inputs.detailedRevenue[m];
                    }
                }
                document.getElementById('inputGrowth').value = data.inputs.growth || '5,00';
                document.getElementById('inputYears').value = data.inputs.years || 5;
            }
            
            initAnnualRates(); 
            updateDashboard();
        }

        // --- EXPORT/IMPORT LOCAL ---
        function exportToJson() {
            const data = getSaveData();
            const clientName = document.getElementById('inputClientName').value || "Cliente_Sem_Nome";
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `planejamento_${clientName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importFromJson(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    applyLoadedData(data);
                    
                    const fName = file.name;
                    if(fName.includes('planejamento_')) {
                        let namePart = fName.split('planejamento_')[1].split('_202')[0];
                        document.getElementById('inputClientName').value = namePart.replace(/_/g, ' ');
                    }
                    
                    alert('Cenário carregado com sucesso!');
                } catch (err) {
                    alert('Erro ao ler arquivo JSON.');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- CLOUD EXPORT/IMPORT ---
        function setCloudLoader(active, text = "Processando na Nuvem...") {
            const loader = document.getElementById('cloudLoader');
            document.getElementById('cloudLoaderText').innerText = text;
            if(active) {
                loader.classList.remove('hidden');
                loader.style.display = 'flex';
            } else {
                loader.classList.add('hidden');
                loader.style.display = 'none';
            }
        }

        function saveToCloud(callback = null) {
            if(!APPS_SCRIPT_WEB_APP_URL || APPS_SCRIPT_WEB_APP_URL.includes("COLE_AQUI")) {
                alert("Por favor, insira a URL do Google Apps Script.");
                return;
            }

            const clientName = document.getElementById('inputClientName').value.trim();
            if (!clientName) {
                alert("Por favor, preencha o campo 'Nome do Cliente' antes de salvar na nuvem.");
                document.getElementById('inputClientName').focus();
                return;
            }

            const payloadData = getSaveData();
            setCloudLoader(true, "Salvando cliente na nuvem...");

            fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                redirect: 'follow', 
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'save', // NOVO: Parametro de ação incluso
                    clientName: clientName,
                    payload: payloadData
                })
            })
            .then(response => response.json())
            .then(data => {
                setCloudLoader(false);
                if(data.status === 'success') {
                    if(callback) callback(clientName);
                    else alert(data.message);
                } else {
                    alert("Erro ao salvar: " + data.message);
                }
            })
            .catch(error => {
                setCloudLoader(false);
                console.error("Erro no fetch: ", error);
                alert("Falha na comunicação com a nuvem (Erro de CORS/Rede). Certifique-se de que o Apps Script foi implantado para acesso de 'Qualquer Pessoa'.");
            });
        }

        // --- SOLUÇÃO PRÁTICA 1: Link Compartilhável via Nuvem ---
        function generateShareableLink() {
            saveToCloud(function(clientName) {
                const isLocal = window.location.protocol === 'file:';
                let baseLink = window.location.href.split('?')[0].split('#')[0];
                let shareUrl = `${baseLink}?view=client&clientName=${encodeURIComponent(clientName)}`;
                
                if (isLocal) {
                    alert("⚠️ AVISO: Você está usando este sistema através de um arquivo local no seu computador (file://).\n\nPara que o cliente consiga acessar o link pela internet, você precisaria hospedar este HTML em um servidor web.\n\nSugestão: Utilize o botão verde 'Baixar Apresentação (.HTML)' logo acima para enviar o arquivo diretamente ao cliente!");
                }

                navigator.clipboard.writeText(shareUrl).then(function() {
                    if(!isLocal) alert("✅ Link Interativo Gerado e Copiado!\n\nLink:\n" + shareUrl);
                }, function(err) {
                    prompt("Copie o link abaixo e envie para o cliente:", shareUrl);
                });
            });
        }

        // --- SOLUÇÃO PRÁTICA 2: Exportar Apresentação HTML Limpa para Cliente ---
        function exportInteractiveHTML() {
            const clientName = document.getElementById('inputClientName').value.trim() || "Cliente";
            
            // Garante que o relatorio esta renderizado para o canvas existir
            if (!globalCalculationData) {
                alert("Calcule os dados primeiro!");
                return;
            }
            
            // Força a renderização se necessário
            renderClientReport(globalCalculationData);
            
            setCloudLoader(true, "Gerando Relatório Estático Inalterável...");
            
            // Timeout para dar tempo do Chart.js animar e desenhar no Canvas
            setTimeout(() => {
                // 1. Pega o Container do Relatório
                const reportElement = document.getElementById('view-report');
                
                // 2. Clona o nó inteiro para podermos mexer sem estragar a tela
                let cloneDoc = reportElement.cloneNode(true);
                
                // Remove a classe de esconder, pra ter certeza que aparece
                cloneDoc.classList.remove('hidden');
                cloneDoc.style.display = 'block';
                cloneDoc.style.margin = '0 auto';
                cloneDoc.style.marginBottom = '2rem';
                
                // 3. Resolve o Problema do Gráfico (Canvas fica branco em cópias/exports nativos)
                const originalCanvas = document.getElementById('chartReport');
                if (originalCanvas) {
                    const imgData = originalCanvas.toDataURL('image/png');
                    const canvasClone = cloneDoc.querySelector('#chartReport');
                    if (canvasClone) {
                        const imgNode = document.createElement('img');
                        imgNode.src = imgData;
                        imgNode.style.width = '100%';
                        imgNode.style.height = '100%';
                        imgNode.style.objectFit = 'contain';
                        imgNode.alt = 'Gráfico Tributário';
                        canvasClone.parentNode.replaceChild(imgNode, canvasClone);
                    }
                }

                // 4. Remove os botões de ação do cliente (Impressão etc)
                const floatingBtns = cloneDoc.querySelector('#clientFloatingButtons');
                if (floatingBtns) floatingBtns.remove();

                // 5. Monta a estrutura HTML final
                let htmlContent = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudo Tributário - ${clientName}</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            padding: 2rem 1rem; 
        }
        .report-container { 
            max-width: 210mm; 
            margin: 0 auto; 
            background: white; 
            padding: 3rem; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
            border-radius: 0.75rem; 
            border: 1px solid #e2e8f0;
        }
        @media print {
            body { background-color: white; padding: 0; }
            .report-container { box-shadow: none; padding: 0; max-width: 100%; border: none; }
            .print-break { page-break-before: always; }
            .print-avoid-break { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="report-container">
        ${cloneDoc.innerHTML}
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Desabilita cliques em links e botões, caso tenham sobrado
            document.querySelectorAll('a, button').forEach(el => {
                el.style.pointerEvents = 'none';
            });
            // Força as tabelas detalhadas a ficarem sempre abertas se houver 'details' tag
            document.querySelectorAll('details').forEach(el => {
                el.open = true;
                el.style.pointerEvents = 'none';
            });
        });
    <\/script>
</body>
</html>`;
                
                // 6. Faz o download
                const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Estudo_Tributario_${clientName.replace(/\s+/g, '_')}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setCloudLoader(false);
                alert("Apresentação Estática gerada com sucesso! \n\nEste arquivo .html contém apenas a visão final do relatório. Basta enviar este arquivo direto pelo WhatsApp do seu cliente e ele verá perfeitamente.");
            }, 800); 
        }

        // --- Checagem de Carregamento ao iniciar (Verifica Link) ---
        function checkInitModes() {
            const params = new URLSearchParams(window.location.search);
            if(params.get('view') === 'client' && params.get('clientName')) {
                setupClientViewMode();
                const cName = decodeURIComponent(params.get('clientName'));
                
                setCloudLoader(true, "Carregando Apresentação Interativa...");
                
                fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'load', clientName: cName })
                })
                .then(res => res.json())
                .then(data => {
                    setCloudLoader(false);
                    if(data.status === 'success' && data.data) {
                        // NOVO: Parse do JSON garantindo os dados antes de aplicar
                        let loadedData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;
                        applyLoadedData(loadedData);
                        document.getElementById('inputClientName').value = cName;
                        
                        // Garante que o relatório seja a aba ativa
                        switchTab('report', null);
                        
                        // Finaliza o carregamento suave
                        setTimeout(() => {
                            const loader = document.getElementById('initial-client-loader');
                            if(loader) {
                                loader.style.opacity = '0';
                                setTimeout(() => {
                                    loader.remove();
                                    document.body.classList.remove('is-loading-client');
                                }, 500);
                            }
                        }, 600);
                    } else {
                        document.body.classList.remove('is-loading-client');
                        const loader = document.getElementById('initial-client-loader');
                        if(loader) loader.remove();
                        alert("Erro ao carregar dados do cliente via Link.");
                    }
                })
                .catch(err => {
                    setCloudLoader(false);
                    document.body.classList.remove('is-loading-client');
                    const loader = document.getElementById('initial-client-loader');
                    if(loader) loader.remove();
                    alert("Erro na conexão com a nuvem.");
                    console.error(err);
                });
                return true;
            }
            return false;
        }

        function setupClientViewMode() {
            isClientViewMode = true;
            document.getElementById('sidebar').style.display = 'none';
            if(document.getElementById('sidebarOverlay')) document.getElementById('sidebarOverlay').style.display = 'none';
            document.getElementById('mobileHeader').style.display = 'none';
            document.getElementById('navTabs').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('pt-16', 'md:pt-0');
            document.getElementById('mainScroll').classList.remove('bg-slate-100');
            document.getElementById('mainScroll').classList.add('bg-white');
        }

        // --- MANEJO DE NUVEM CONT. ---
        function openCloudLoadModal() {
            if(!APPS_SCRIPT_WEB_APP_URL || APPS_SCRIPT_WEB_APP_URL.includes("COLE_AQUI")) {
                alert("Por favor, insira a URL do Google Apps Script no início do arquivo HTML.");
                return;
            }

            const modal = document.getElementById('cloudLoadModal');
            const listContainer = document.getElementById('cloudClientsList');
            
            listContainer.innerHTML = '<div class="flex items-center justify-center py-6 text-slate-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Buscando clientes...</div>';
            
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); }, 10);

            fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'list' })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    if(data.clients.length === 0) {
                        listContainer.innerHTML = '<div class="text-center py-6 text-slate-500">Nenhum cliente salvo na nuvem ainda.</div>';
                        return;
                    }

                    let html = '<div class="space-y-2">';
                    data.clients.forEach(client => {
                        html += `
                        <div class="flex justify-between items-center p-3 bg-slate-50 border border-slate-200 rounded-lg hover:bg-slate-100 transition">
                            <span class="font-bold text-slate-700"><i class="fa-solid fa-user text-slate-400 mr-2"></i>${client}</span>
                            <div class="flex gap-2">
                                <button onclick="deleteFromCloud('${client}')" class="px-2.5 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 rounded text-xs font-bold transition shadow-sm" title="Excluir">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <button onclick="loadFromCloud('${client}')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-bold transition shadow-sm">
                                    Carregar
                                </button>
                            </div>
                        </div>
                        `;
                    });
                    html += '</div>';
                    listContainer.innerHTML = html;
                } else {
                    listContainer.innerHTML = `<div class="text-center py-6 text-red-500">Erro: ${data.message}</div>`;
                }
            })
            .catch(err => {
                listContainer.innerHTML = `<div class="text-center py-6 text-red-500">Erro de conexão. Verifique se o Apps Script foi implantado como Acesso "Qualquer Pessoa".</div>`;
                console.error(err);
            });
        }

        function closeCloudLoadModal() {
            const modal = document.getElementById('cloudLoadModal');
            modal.classList.add('opacity-0'); modal.children[0].classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function loadFromCloud(clientName) {
            closeCloudLoadModal();
            setCloudLoader(true, "Carregando dados...");

            fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'load', clientName: clientName })
            })
            .then(res => res.json())
            .then(data => {
                setCloudLoader(false);
                if(data.status === 'success' && data.data) {
                    // NOVO: Parse do JSON garantindo os dados antes de aplicar
                    let loadedData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;
                    applyLoadedData(loadedData);
                    document.getElementById('inputClientName').value = clientName;
                    alert("Cliente carregado com sucesso!");
                } else {
                    alert("Erro ao carregar dados: " + (data.message || "Dados não encontrados"));
                }
            })
            .catch(err => {
                setCloudLoader(false);
                alert("Erro na conexão com a nuvem.");
                console.error(err);
            });
        }

        function deleteFromCloud(clientName) {
            if(!confirm(`Tem certeza absoluta que deseja excluir o cliente "${clientName}" da base de dados na nuvem? Essa ação não pode ser desfeita.`)) return;
            
            setCloudLoader(true, "Excluindo cliente...");
            fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'delete',
                    clientName: clientName
                })
            })
            .then(response => response.json())
            .then(data => {
                setCloudLoader(false);
                if(data.status === 'success') {
                    alert(data.message);
                    openCloudLoadModal(); 
                } else {
                    alert("Erro ao excluir: " + data.message);
                }
            })
            .catch(error => {
                setCloudLoader(false);
                console.error("Erro no fetch: ", error);
                alert("Falha na comunicação ao tentar excluir da nuvem.");
            });
        }

        // --- EXPORT TO EXCEL ---
        function exportToExcel() {
            if(!globalCalculationData) { alert('Sem dados para exportar.'); return; }
            
            const wb = XLSX.utils.book_new();
            const formatForExcel = (val) => typeof val === 'number' ? val : 0;
            const clientName = document.getElementById('inputClientName').value || "Cliente_Sem_Nome";

            const wsConsolidadoData = [['Ano', 'Faturamento Bruto', 'Aluguel (Impostos)', 'Holding (Impostos)']];
            globalCalculationData.years.forEach((y, i) => {
                wsConsolidadoData.push([
                    y,
                    formatForExcel(globalCalculationData.grossRevenue[i]),
                    formatForExcel(globalCalculationData.aluguel.taxArr[i]),
                    formatForExcel(globalCalculationData.holding.taxArr[i])
                ]);
            });
            const wsConsolidado = XLSX.utils.aoa_to_sheet(wsConsolidadoData);
            XLSX.utils.book_append_sheet(wb, wsConsolidado, "Consolidado");

            const wsAluguelData = [['Mês/Ano', 'Faturamento', 'IRPF (Carnê)', 'IBS', 'CBS', 'Total Impostos', 'Líquido']];
            globalCalculationData.monthlyData.forEach(row => {
                wsAluguelData.push([
                    row.date,
                    formatForExcel(row.gross),
                    formatForExcel(row.aluguel.irpf),
                    formatForExcel(row.aluguel.pfIbs),
                    formatForExcel(row.aluguel.pfCbs),
                    formatForExcel(row.aluguel.tax),
                    formatForExcel(row.aluguel.net)
                ]);
            });
            const wsAluguel = XLSX.utils.aoa_to_sheet(wsAluguelData);
            XLSX.utils.book_append_sheet(wb, wsAluguel, "Aluguel Detalhado");

            const wsHoldingData = [['Mês/Ano', 'Faturamento', 'PIS/COFINS', 'IBS', 'CBS', 'IRPJ', 'Adicional', 'CSLL', 'Total Impostos', 'Líquido']];
            globalCalculationData.monthlyData.forEach(row => {
                wsHoldingData.push([
                    row.date,
                    formatForExcel(row.gross),
                    formatForExcel(row.holding.pisCofins),
                    formatForExcel(row.holding.ibs),
                    formatForExcel(row.holding.cbs),
                    formatForExcel(row.holding.irpj),
                    formatForExcel(row.holding.adicional),
                    formatForExcel(row.holding.csll),
                    formatForExcel(row.holding.tax),
                    formatForExcel(row.holding.net)
                ]);
            });
            const wsHolding = XLSX.utils.aoa_to_sheet(wsHoldingData);
            XLSX.utils.book_append_sheet(wb, wsHolding, "Holding Detalhado");

            XLSX.writeFile(wb, `Planejamento_${clientName.replace(/\s+/g, '_')}.xlsx`);
        }
        
        // --- GERADOR PDF PROFISSIONAL COM HTML2PDF ---
        // =========================================================================
        // MOTOR DE PDF PROFISSIONAL (VETORIAL DE ALTA FIDELIDADE)
        // =========================================================================
        
        /**
         * A melhor maneira técnica de gerar PDFs profissionais: 
         * Usa o motor de renderização nativo do navegador via Iframe oculto.
         * Resultado: PDF Vetorial, texto pesquisável, gráficos perfeitos e leve.
         */
        function generateProfessionalPDF() {
            setCloudLoader(true, "Preparando PDF Vetorial...");

            // 1. Garante que os dados do relatório estão atualizados
            if (globalCalculationData) {
                renderClientReport(globalCalculationData);
            }

            // 2. Aguarda renderização dos gráficos
            setTimeout(() => {
                const reportContent = document.getElementById('view-report');
                
                // Cria um Iframe temporário oculto
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.right = '0';
                iframe.style.bottom = '0';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = 'none';
                document.body.appendChild(iframe);

                const doc = iframe.contentWindow.document;

                // 3. Copia os estilos necessários para o Iframe
                const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]'))
                    .map(style => style.outerHTML)
                    .join('\n');

                // 4. Prepara o conteúdo HTML para o motor de impressão
                // Clonamos o conteúdo e removemos elementos de interface
                const contentClone = reportContent.cloneNode(true);
                contentClone.classList.remove('hidden', 'shadow-xl', 'border', 'mx-auto', 'max-w-[210mm]');
                
                // Trata especificamente o Canvas (converte para imagem para o Iframe)
                const originalCanvas = reportContent.querySelector('#chartReport');
                const cloneCanvas = contentClone.querySelector('#chartReport');
                if (originalCanvas && cloneCanvas) {
                    const imgData = originalCanvas.toDataURL('image/png');
                    const imgNode = document.createElement('img');
                    imgNode.src = imgData;
                    imgNode.style.width = '100%';
                    cloneCanvas.parentNode.replaceChild(imgNode, cloneCanvas);
                }

                const floatingBtns = contentClone.querySelector('#clientFloatingButtons');
                if(floatingBtns) floatingBtns.remove();

                // 5. Monta o documento de impressão
                doc.open();
                doc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Estudo Tributário</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        ${styles}
                        <style>
                            @page { size: A4 portrait; margin: 15mm; }
                            body { background: white !important; padding: 0 !important; margin: 0 !important; }
                            .view-section { display: block !important; width: 100% !important; border: none !important; box-shadow: none !important; }
                            table { width: 100% !important; border-collapse: collapse !important; page-break-inside: auto; }
                            tr { page-break-inside: avoid !important; page-break-after: auto; }
                            thead { display: table-header-group !important; } /* REPETE CABEÇALHO */
                            .print-avoid-break { page-break-inside: avoid !important; }
                            canvas, img { max-width: 100% !important; height: auto !important; page-break-inside: avoid !important; }
                        </style>
                    </head>
                    <body>
                        ${contentClone.innerHTML}
                        <script>
                            // Aguarda o carregamento do Tailwind e imagens
                            window.onload = () => {
                                setTimeout(() => {
                                    window.print();
                                    window.frameElement.remove();
                                }, 500);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                doc.close();

                setCloudLoader(false);
                alert("DICA PROFISSIONAL:\n\nNa janela que abrir, escolha 'Salvar como PDF' no destino da impressora.\n\nIsso gerará um arquivo vetorial de altíssima qualidade com textos selecionáveis e gráficos perfeitos.");
            }, 1000);
        }

        // Mantemos a função avançada para quem prefere o método de imagem personalizado
        function generatePdfFromAdvanced() {
            setCloudLoader(true, "Finalizando PDF Personalizado...");
            const previewElement = document.getElementById('pdf-cloned-content');
            const scale = parseFloat(document.getElementById('pdfScale').value) || 2.5;
            const clientName = (document.getElementById('inputClientName').value || "Cliente").trim();

            const opt = {
                margin:       [10, 5, 10, 5],
                filename:     `Relatorio_Consultoria_${clientName.replace(/\s+/g, '_')}.pdf`,
                image:        { type: 'jpeg', quality: 1.0 },
                html2canvas:  { 
                    scale: scale, 
                    useCORS: true,
                    letterRendering: true,
                    scrollY: 0,
                    scrollX: 0,
                    windowWidth: 800 
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['css', 'legacy'], avoid: ['tr', 'canvas'] }
            };

            html2pdf().set(opt).from(previewElement).save().then(() => {
                setCloudLoader(false);
                closeAdvancedPdfModal();
            }).catch(err => {
                console.error(err);
                setCloudLoader(false);
                alert("Erro ao processar o arquivo.");
            });
        }

        // --- LÓGICA DE PRÉ-VISUALIZAÇÃO AVANÇADA ---
        function openAdvancedPdfModal() {
            setCloudLoader(true, "Preparando Ambiente de Edição...");
            
            if (globalCalculationData) renderClientReport(globalCalculationData);
            
            setTimeout(() => {
                const modal = document.getElementById('advancedPdfModal');
                const previewContent = document.getElementById('pdfLivePreview');
                const sourceElement = document.getElementById('view-report');
                
                // Clona para o preview (este clone é apenas visual)
                const clone = sourceElement.cloneNode(true);
                clone.id = "pdf-cloned-content";
                clone.classList.remove('hidden', 'shadow-xl', 'border', 'mx-auto');
                clone.style.width = "210mm";
                clone.style.padding = "15mm";
                clone.style.boxShadow = "none";
                
                // Converte canvas para imagem no preview para garantir fidelidade visual
                const originalCanvas = sourceElement.querySelector('#chartReport');
                const cloneCanvas = clone.querySelector('#chartReport');
                if (originalCanvas && cloneCanvas) {
                    cloneCanvas.parentNode.replaceChild(originalCanvas.cloneNode(true), cloneCanvas);
                    const ctx = clone.querySelector('#chartReport').getContext('2d');
                    ctx.drawImage(originalCanvas, 0, 0);
                }

                previewContent.innerHTML = '';
                previewContent.appendChild(clone);
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.max-w-6xl').classList.remove('scale-95');
                    setCloudLoader(false);
                }, 10);
            }, 800);
        }

        function closeAdvancedPdfModal() {
            const modal = document.getElementById('advancedPdfModal');
            modal.classList.add('opacity-0');
            modal.querySelector('.max-w-6xl').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
            toggleEditableReport(false);
        }

        function toggleReportSection(sectionId, isVisible) {
            const preview = document.getElementById('pdfLivePreview');
            const section = preview.querySelector(`#${sectionId}`);
            if (section) {
                section.style.display = isVisible ? 'block' : 'none';
            }
        }

        function toggleEditableReport(isEnabled) {
            const preview = document.getElementById('pdfLivePreview');
            const editables = preview.querySelectorAll('h1, h2, h3, p, td, th, span');
            
            editables.forEach(el => {
                if (isEnabled) {
                    el.contentEditable = "true";
                    el.classList.add('hover:bg-yellow-50', 'outline-dashed', 'outline-1', 'outline-emerald-300');
                } else {
                    el.contentEditable = "false";
                    el.classList.remove('hover:bg-yellow-50', 'outline-dashed', 'outline-1', 'outline-emerald-300');
                }
            });
        }

        // --- CALCULATION LOGIC ---
        function initAnnualRates() {
            const numYears = parseInt(document.getElementById('inputYears').value) || 5;
            for (let i = 0; i < numYears; i++) {
                let year = startYear + i;
                if (!annualRates[year]) {
                    annualRates[year] = {
                        icms: parseMaskedValue(document.getElementById('taxICMS')?.value || "19"),
                        cbs: parseMaskedValue(document.getElementById('taxCBS')?.value || "8.4"),
                        funrural: parseMaskedValue(document.getElementById('taxFunrural')?.value || "1.5"),
                        ruralIbs: 0,
                        ruralIrpfMethod: 'presumed',
                        ruralExpenseRatio: 60,
                        ruralSimplifiedDiscount: false, 
                        simplifiedDiscountLimit: 16754.34, 
                        
                        piscofins: parseMaskedValue(document.getElementById('taxPisCofins').value), 
                        holdingIbs: 0, 
                        holdingCbs: 0, 
                        irpj: parseMaskedValue(document.getElementById('taxIRPJ').value),
                        csll: parseMaskedValue(document.getElementById('taxCSLL').value),
                        presumedBase: parseMaskedValue(document.getElementById('taxPresumedBase').value),
                        
                        adminFee: 0, 
                        vacancy: 0, 
                        fixedRateSim: 0,
                        pfIbs: 0, 
                        pfCbs: 0,
                        aluguelSimplifiedDiscount: false,
                        aluguelSimplifiedDiscountValue: 607.20
                    };
                }
            }
            renderRateTables();
        }

        function handleYearChange() {
            initAnnualRates();
            updateDashboard();
        }

        function renderRateTables() {
            const numYears = parseInt(document.getElementById('inputYears').value) || 5;
            
            let yearCols = '';
            for (let i = 0; i < numYears; i++) yearCols += `<th class="p-2 border-b text-center min-w-[100px] text-slate-500 font-medium">${startYear + i}</th>`;
            
            const headerHtml = `<th class="p-2 border-b text-slate-600 bg-slate-50 sticky left-0 z-10 w-44 shadow-sm">Parâmetro</th>` + yearCols;
            
            const ruralHeader = document.getElementById('ruralRatesHeader');
            if(ruralHeader) ruralHeader.innerHTML = headerHtml;
            
            document.getElementById('holdingRatesHeader').innerHTML = headerHtml;
            document.getElementById('aluguelRatesHeader').innerHTML = headerHtml;

            const createRow = (label, key, isInput = true, isSelect = false, isToggle = false) => {
                let cells = '';
                for (let i = 0; i < numYears; i++) {
                    let year = startYear + i;
                    if (isSelect) {
                        let selectedP = annualRates[year]['ruralIrpfMethod'] === 'presumed' ? 'selected' : '';
                        let selectedR = annualRates[year]['ruralIrpfMethod'] === 'real' ? 'selected' : '';
                        cells += `<td class="p-1 border-b">
                            <select class="w-full text-center text-[10px] p-1.5 border border-slate-200 rounded focus:border-blue-500 bg-white" onchange="updateAnnualRate(${year}, 'ruralIrpfMethod', this.value)">
                                <option value="presumed" ${selectedP}>Presumido (20%)</option>
                                <option value="real" ${selectedR}>Livro Caixa (Real)</option>
                            </select>
                        </td>`;
                    } else if (isToggle) {
                        let checked = annualRates[year][key] ? 'checked' : '';
                        cells += `<td class="p-1 border-b text-center">
                            <input type="checkbox" ${checked} onchange="updateAnnualRate(${year}, '${key}', this.checked)" class="accent-blue-600 w-4 h-4 cursor-pointer">
                        </td>`;
                    } else {
                        let val = annualRates[year][key].toFixed(2).replace('.', ',');
                        cells += `<td class="p-1 border-b"><input type="text" inputmode="decimal" class="w-full text-center text-xs p-1.5 border border-slate-200 rounded focus:border-blue-500 focus:outline-none ${key.includes('Limit') || key.includes('Value') ? 'dynamic-money' : 'dynamic-percent'} transition bg-white hover:bg-slate-50" value="${val}" oninput="updateAnnualRate(${year}, '${key}', this.value)"></td>`;
                    }
                }
                return `<tr><td class="p-2 border-b font-medium text-slate-700 bg-white sticky left-0 z-10 border-r border-slate-100 text-xs">${label}</td>${cells}</tr>`;
            };

            const ruralBody = document.getElementById('ruralRatesBody');
            if (ruralBody) {
                ruralBody.innerHTML = 
                    createRow('Método IRPF', 'ruralIrpfMethod', false, true) + 
                    createRow('% Despesas (Livro Caixa)', 'ruralExpenseRatio') +
                    createRow('Desc. Simplificado (DAA)', 'ruralSimplifiedDiscount', false, false, true) + 
                    createRow('Limite Desc. Simpl. (R$)', 'simplifiedDiscountLimit') + 
                    createRow('ICMS', 'icms') + 
                    createRow('CBS', 'cbs') + 
                    createRow('IBS (Rural)', 'ruralIbs') +
                    createRow('Funrural', 'funrural');
            }

            document.getElementById('holdingRatesBody').innerHTML = 
                createRow('PIS/COFINS (Legado)', 'piscofins') + 
                createRow('IBS (Novo)', 'holdingIbs') + 
                createRow('CBS (Novo)', 'holdingCbs') + 
                createRow('Base Presunção', 'presumedBase') + 
                createRow('IRPJ', 'irpj') + 
                createRow('CSLL', 'csll');

            document.getElementById('aluguelRatesBody').innerHTML = 
                createRow('Desc. Simplificado Mensal?', 'aluguelSimplifiedDiscount', false, false, true) +
                createRow('Valor Desc. Mensal (R$)', 'aluguelSimplifiedDiscountValue') +
                createRow('IBS (PF)', 'pfIbs') + 
                createRow('CBS (PF)', 'pfCbs');
            
            setupDynamicInputs(); 
        }

        function updateAnnualRate(year, type, value) {
            if(!annualRates[year]) initAnnualRates();
            if(type === 'ruralIrpfMethod') {
                annualRates[year][type] = value;
            } else if (type === 'ruralSimplifiedDiscount' || type === 'aluguelSimplifiedDiscount') {
                annualRates[year][type] = value; 
            } else {
                annualRates[year][type] = parseMaskedValue(value);
            }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updateDashboard, 300);
        }

        function calculateIRPF(monthlyIncome) {
            let tax = 0;
            for (let bracket of irpfTables.monthly) {
                if (monthlyIncome <= bracket.limit) {
                    tax = (monthlyIncome * (bracket.rate / 100)) - bracket.ded;
                    break;
                }
            }
            return Math.max(0, tax);
        }

        function calculateAnnualIRPF(annualIncome) {
            let tax = 0;
            for (let bracket of irpfTables.annual) {
                if (annualIncome <= bracket.limit) {
                    tax = (annualIncome * (bracket.rate / 100)) - bracket.ded;
                    break;
                }
            }
            return Math.max(0, tax);
        }

        function openIrpfConfigModal() {
            renderIrpfConfigTable('monthly', 'bodyIrpfMonthly');
            renderIrpfConfigTable('annual', 'bodyIrpfAnnual');
            const modal = document.getElementById('irpfConfigModal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); }, 10);
        }

        function closeIrpfConfigModal() {
            const modal = document.getElementById('irpfConfigModal');
            modal.classList.add('opacity-0'); modal.children[0].classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            updateDashboard();
        }

        function renderIrpfConfigTable(type, bodyId) {
            const tbody = document.getElementById(bodyId);
            let html = '';
            irpfTables[type].forEach((row, index) => {
                let limitVal = row.limit > 900000000 ? '' : row.limit.toFixed(2).replace('.', ',');
                let rateVal = row.rate.toFixed(2).replace('.', ',');
                let dedVal = row.ded.toFixed(2).replace('.', ',');
                
                html += `
                <tr class="border-b border-slate-100 last:border-0 hover:bg-slate-50">
                    <td class="p-2"><input type="text" class="w-full text-xs p-1 border rounded dynamic-money" value="${limitVal}" placeholder="Acima de..." oninput="updateIrpfTable('${type}', ${index}, 'limit', this.value)"></td>
                    <td class="p-2"><input type="text" class="w-full text-xs p-1 border rounded dynamic-percent" value="${rateVal}" oninput="updateIrpfTable('${type}', ${index}, 'rate', this.value)"></td>
                    <td class="p-2"><input type="text" class="w-full text-xs p-1 border rounded dynamic-money" value="${dedVal}" oninput="updateIrpfTable('${type}', ${index}, 'ded', this.value)"></td>
                </tr>`;
            });
            tbody.innerHTML = html;
            setupDynamicInputs();
        }

        function updateIrpfTable(type, index, field, value) {
            let val = parseMaskedValue(value);
            if (field === 'limit' && val === 0 && index === irpfTables[type].length - 1) val = 999999999;
            irpfTables[type][index][field] = val;
        }

        function resetIrpfTables() {
            irpfTables = JSON.parse(JSON.stringify(defaultIrpfTables));
            renderIrpfConfigTable('monthly', 'bodyIrpfMonthly');
            renderIrpfConfigTable('annual', 'bodyIrpfAnnual');
        }

        function calculateData() {
            const revenueMode = document.getElementById('inputRevenueMode')?.value || 'fixed';
            const initialMonthlyRev = parseMaskedValue(document.getElementById('inputMonthlyRevenue')?.value || "0") || 0;
            const growthRate = parseMaskedValue(document.getElementById('inputGrowth').value) / 100;
            const numYears = parseInt(document.getElementById('inputYears').value) || 5;
            
            const isIcmsExempt = document.getElementById('chkIcmsExempt') ? document.getElementById('chkIcmsExempt').checked : false;
            
            let initialDetailedRev = [];
            if (revenueMode === 'detailed') {
                for(let m=1; m<=12; m++) {
                    initialDetailedRev[m] = parseMaskedValue(document.getElementById(`inputMonthVal${m}`)?.value || "0") || 0;
                }
            }

            if(Object.keys(annualRates).length < numYears) initAnnualRates();

            let result = {
                years: [],
                grossRevenue: [],
                totalGross: 0,
                monthlyData: [],
                rural: { totalNet: 0, totalTax: 0, netArr: [], taxArr: [], effectiveRates: [], annualDetails: {icms:[], cbs:[], fun:[], ibs:[], annualIrpf:[]}, annualReports: [] },
                aluguel: { totalNet: 0, totalTax: 0, netArr: [], taxArr: [], effectiveRates: [], annualDetails: {irpf:[], ibs:[], cbs:[]} },
                holding: { totalNet: 0, totalTax: 0, netArr: [], taxArr: [], effectiveRates: [], annualDetails: {pis:[], ir:[], cs:[], ad:[], hIbs:[], hCbs:[]} }
            };

            let currentMonthlyBase = initialMonthlyRev;

            for (let i = 0; i < numYears; i++) {
                let year = startYear + i;
                result.years.push(year);
                
                let rates = annualRates[year] || annualRates[startYear];

                let yGross = 0;
                let yRural = { tax: 0, net: 0, icms: 0, cbs: 0, fun: 0, ibs: 0, annualIrpf: 0 };
                let yAluguel = { tax: 0, net: 0, irpf: 0, ibs: 0, cbs: 0 };
                let yHolding = { tax: 0, net: 0, pis: 0, ir: 0, cs: 0, ad: 0, hIbs:0, hCbs:0 };

                let quarterRevenue = 0;
                
                // Cálculo da receita anual estimada para este ano específico
                let estimatedAnnualGross = 0;
                let currentYearMonthlyRevenues = [];
                
                if (revenueMode === 'fixed') {
                    for(let m=1; m<=12; m++) {
                        currentYearMonthlyRevenues[m] = currentMonthlyBase;
                        estimatedAnnualGross += currentMonthlyBase;
                    }
                } else {
                    let compoundGrowth = Math.pow(1 + growthRate, i);
                    for(let m=1; m<=12; m++) {
                        currentYearMonthlyRevenues[m] = initialDetailedRev[m] * compoundGrowth;
                        estimatedAnnualGross += currentYearMonthlyRevenues[m];
                    }
                }

                let ruralBaseCalc = 0;
                let deductionValue = 0;
                let discountUsed = 0;

                if (rates.ruralIrpfMethod === 'presumed') {
                    ruralBaseCalc = estimatedAnnualGross * 0.20;
                    deductionValue = estimatedAnnualGross * 0.80; 
                } else {
                    deductionValue = estimatedAnnualGross * (rates.ruralExpenseRatio / 100);
                    ruralBaseCalc = Math.max(0, estimatedAnnualGross - deductionValue);
                }
                
                if (rates.ruralSimplifiedDiscount) {
                    let limit = rates.simplifiedDiscountLimit || 16754.34;
                    discountUsed = Math.min(ruralBaseCalc * 0.20, limit);
                    ruralBaseCalc = Math.max(0, ruralBaseCalc - discountUsed);
                }

                let annualIrpfRural = calculateAnnualIRPF(ruralBaseCalc);
                
                result.rural.annualReports.push({
                    year: year,
                    gross: estimatedAnnualGross,
                    method: rates.ruralIrpfMethod === 'presumed' ? 'Presumido (20%)' : 'Livro Caixa',
                    deduction: deductionValue,
                    baseInitial: estimatedAnnualGross - deductionValue, 
                    simplifiedDiscount: discountUsed,
                    baseFinal: ruralBaseCalc,
                    tax: annualIrpfRural
                });

                for (let m = 1; m <= 12; m++) {
                    let gross = currentYearMonthlyRevenues[m];
                    
                    let effectiveIcmsRate = isIcmsExempt ? 0 : rates.icms;
                    let vICMS = gross * (effectiveIcmsRate / 100);
                    let vCBS = gross * (rates.cbs / 100);
                    let vFun = gross * (rates.funrural / 100);
                    let vIBS = gross * (rates.ruralIbs / 100); 
                    
                    // Distribuir o IRPF Rural proporcionalmente ao faturamento mensal para fluxo de caixa mais realista
                    let monthlyIrpfShare = estimatedAnnualGross > 0 ? (gross / estimatedAnnualGross) * annualIrpfRural : 0; 

                    let tRural = vICMS + vCBS + vFun + vIBS + monthlyIrpfShare;
                    yRural.icms += vICMS; yRural.cbs += vCBS; yRural.fun += vFun; yRural.ibs += vIBS;
                    yRural.annualIrpf += monthlyIrpfShare;
                    yRural.tax += tRural; yRural.net += (gross - tRural);

                    let vPfIbs = gross * (rates.pfIbs / 100);
                    let vPfCbs = gross * (rates.pfCbs / 100);
                    
                    let aluguelBase = gross;
                    let vDescSimplificado = 0;
                    if(rates.aluguelSimplifiedDiscount && gross > 0) {
                        vDescSimplificado = rates.aluguelSimplifiedDiscountValue || 607.20;
                        aluguelBase = Math.max(0, gross - vDescSimplificado);
                    }

                    let vIrpf = 0;
                    let irpfBracket = { rate: 0, ded: 0 };
                    for (let bracket of irpfTables.monthly) {
                        if (aluguelBase <= bracket.limit) {
                            vIrpf = (aluguelBase * (bracket.rate / 100)) - bracket.ded;
                            irpfBracket = { rate: bracket.rate, ded: bracket.ded, limit: bracket.limit };
                            break;
                        }
                    }
                    vIrpf = Math.max(0, vIrpf);
                    
                    let tAluguel = vIrpf + vPfIbs + vPfCbs;
                    let netAluguel = gross - tAluguel;
                    yAluguel.tax += tAluguel; yAluguel.net += netAluguel;
                    yAluguel.irpf += vIrpf; yAluguel.ibs += vPfIbs; yAluguel.cbs += vPfCbs;

                    let vPisCofins = gross * (rates.piscofins / 100);
                    let vHoldIbs = gross * (rates.holdingIbs / 100);
                    let vHoldCbs = gross * (rates.holdingCbs / 100);
                    let monthlyTaxes = vPisCofins + vHoldIbs + vHoldCbs;

                    quarterRevenue += gross;
                    let qRev = 0, qBase = 0;
                    let vIrpj = 0, vAdicional = 0, vCsll = 0;

                    if (m % 3 === 0) {
                        qRev = quarterRevenue;
                        let quarterBase = 0;
                        const limitPresumed = 1250000;
                        const highPresumedRate = 35.20;

                        if (quarterRevenue <= limitPresumed) {
                            quarterBase = quarterRevenue * (rates.presumedBase / 100);
                        } else {
                            let baseStandard = limitPresumed * (rates.presumedBase / 100);
                            let excessRevenue = quarterRevenue - limitPresumed;
                            let baseExcess = excessRevenue * (highPresumedRate / 100);
                            quarterBase = baseStandard + baseExcess;
                        }
                        
                        qBase = quarterBase;

                        vIrpj = quarterBase * (rates.irpj / 100);
                        vCsll = quarterBase * (rates.csll / 100);
                        if (quarterBase > 60000) { vAdicional = (quarterBase - 60000) * 0.10; }
                        quarterRevenue = 0;
                    }

                    let tHolding = monthlyTaxes + vIrpj + vAdicional + vCsll;
                    let netHolding = gross - tHolding;

                    yHolding.pis += vPisCofins; 
                    yHolding.hIbs += vHoldIbs; yHolding.hCbs += vHoldCbs;
                    yHolding.ir += vIrpj; yHolding.cs += vCsll; yHolding.ad += vAdicional;
                    yHolding.tax += tHolding; yHolding.net += netHolding;

                    result.monthlyData.push({
                        id: result.monthlyData.length,
                        date: `${m.toString().padStart(2,'0')}/${year}`,
                        gross: gross,
                        rural: { 
                            tax: tRural, net: gross - tRural, 
                            icms: vICMS, cbs: vCBS, fun: vFun, ibs: vIBS,
                            irpfAnnualShare: monthlyIrpfShare,
                            icmsRate: effectiveIcmsRate, cbsRate: rates.cbs, funRate: rates.funrural, ibsRate: rates.ruralIbs
                        },
                        aluguel: { 
                            tax: tAluguel, net: netAluguel, irpf: vIrpf,
                            pfIbs: vPfIbs, pfIbsRate: rates.pfIbs, pfCbs: vPfCbs, pfCbsRate: rates.pfCbs,
                            simplifiedUsed: rates.aluguelSimplifiedDiscount,
                            irpfBase: aluguelBase,
                            irpfBracketRate: irpfBracket.rate,
                            irpfBracketDed: irpfBracket.ded,
                            irpfDescSimplificadoVal: vDescSimplificado
                        },
                        holding: { 
                            tax: tHolding, net: netHolding, 
                            pisCofins: vPisCofins, pisCofinsRate: rates.piscofins,
                            ibs: vHoldIbs, ibsRate: rates.holdingIbs,
                            cbs: vHoldCbs, cbsRate: rates.holdingCbs,
                            irpj: vIrpj, irpjRate: rates.irpj,
                            csll: vCsll, csllRate: rates.csll,
                            adicional: vAdicional, isQuarterMonth: (m % 3 === 0),
                            presumedBase: (m % 3 === 0) ? rates.presumedBase : 0,
                            quarterAccRevenue: qRev,
                            quarterBaseValue: qBase
                        }
                    });

                    yGross += gross;
                }

                result.grossRevenue.push(yGross);
                result.totalGross += yGross;

                result.rural.netArr.push(yRural.net);
                result.rural.taxArr.push(yRural.tax);
                result.rural.totalNet += yRural.net;
                result.rural.totalTax += yRural.tax;
                result.rural.effectiveRates.push((yGross > 0) ? (yRural.tax / yGross) * 100 : 0);
                result.rural.annualDetails.icms.push(yRural.icms);
                result.rural.annualDetails.cbs.push(yRural.cbs);
                result.rural.annualDetails.ibs.push(yRural.ibs);
                result.rural.annualDetails.fun.push(yRural.fun);
                result.rural.annualDetails.annualIrpf.push(yRural.annualIrpf);

                result.aluguel.netArr.push(yAluguel.net);
                result.aluguel.taxArr.push(yAluguel.tax);
                result.aluguel.totalNet += yAluguel.net;
                result.aluguel.totalTax += yAluguel.tax;
                result.aluguel.effectiveRates.push((yGross > 0) ? (yAluguel.tax / yGross) * 100 : 0);
                result.aluguel.annualDetails.irpf.push(yAluguel.irpf);
                result.aluguel.annualDetails.ibs.push(yAluguel.ibs);
                result.aluguel.annualDetails.cbs.push(yAluguel.cbs);

                result.holding.netArr.push(yHolding.net);
                result.holding.taxArr.push(yHolding.tax);
                result.holding.totalNet += yHolding.net;
                result.holding.totalTax += yHolding.tax;
                result.holding.effectiveRates.push((yGross > 0) ? (yHolding.tax / yGross) * 100 : 0);
                result.holding.annualDetails.pis.push(yHolding.pis);
                result.holding.annualDetails.hIbs.push(yHolding.hIbs);
                result.holding.annualDetails.hCbs.push(yHolding.hCbs);
                result.holding.annualDetails.ir.push(yHolding.ir);
                result.holding.annualDetails.cs.push(yHolding.cs);
                result.holding.annualDetails.ad.push(yHolding.ad);

                currentMonthlyBase = currentMonthlyBase * (1 + growthRate);
            }
            
            globalCalculationData = result;
            return result;
        }

        function updateDashboard() {
            const data = calculateData();

            const valTaxRural = document.getElementById('valTaxRural');
            if(valTaxRural) valTaxRural.innerText = formatCurrency(data.rural.totalTax);
            
            const valTaxAluguel = document.getElementById('valTaxAluguel');
            if(valTaxAluguel) valTaxAluguel.innerText = formatCurrency(data.aluguel.totalTax);
            
            const valTaxHolding = document.getElementById('valTaxHolding');
            if(valTaxHolding) valTaxHolding.innerText = formatCurrency(data.holding.totalTax);

            const safeDiv = (n, d) => d > 0 ? (n/d)*100 : 0;
            
            const taxRateRural = document.getElementById('taxRateRural');
            if(taxRateRural) taxRateRural.innerText = formatPercent(safeDiv(data.rural.totalTax, data.totalGross));
            
            const taxRateAluguel = document.getElementById('taxRateAluguel');
            if(taxRateAluguel) taxRateAluguel.innerText = formatPercent(safeDiv(data.aluguel.totalTax, data.totalGross));
            
            const taxRateHolding = document.getElementById('taxRateHolding');
            if(taxRateHolding) taxRateHolding.innerText = formatPercent(safeDiv(data.holding.totalTax, data.totalGross));

            updateCharts(data);
            renderAnnualTable(data);
            renderModuleTables(data);
            renderRuralAnnualReport(data); 
            
            if(document.getElementById('view-report').classList.contains('hidden') === false || isClientViewMode) {
                renderClientReport(data);
            }
        }

        function adjustFontSize(elementId, text, baseSizeClass) {
            const el = document.getElementById(elementId);
            if(!el) return;
            
            // Remove todas as possíveis classes de tamanho para evitar conflitos
            el.classList.remove('text-3xl', 'text-2xl', 'text-xl', 'text-lg', 'text-base', 'text-sm', 'text-xs');
            
            const len = text.length;
            
            // Lógica mais rigorosa de redução baseada na quantidade de caracteres
            // Considerando que os cards ocupam 1/3 da largura da página
            if (len > 25) {
                el.classList.add('text-xs');
            } else if (len > 20) {
                el.classList.add('text-sm');
            } else if (len > 17) {
                el.classList.add('text-base');
            } else if (len > 14) {
                el.classList.add('text-lg');
            } else if (len > 11) {
                el.classList.add('text-xl');
            } else {
                el.classList.add(baseSizeClass);
            }
        }

        function renderClientReport(data) {
            if(!data) return;

            const clientNameInput = document.getElementById('inputClientName').value.trim();
            document.getElementById('reportClientName').innerText = clientNameInput || "Cliente Não Informado";
            
            const today = new Date();
            document.getElementById('reportDate').innerText = `Data da emissão: ${today.toLocaleDateString('pt-BR')}`;
            
            document.getElementById('reportYearsSpan').innerText = data.years.length;
            
            const grossText = formatCurrency(data.totalGross);
            document.getElementById('reportTotalGross').innerText = grossText;
            adjustFontSize('reportTotalGross', grossText, 'text-2xl');

            const aluguelText = formatCurrency(data.aluguel.totalTax);
            document.getElementById('reportTotalAluguel').innerText = aluguelText;
            adjustFontSize('reportTotalAluguel', aluguelText, 'text-2xl');

            const holdingText = formatCurrency(data.holding.totalTax);
            document.getElementById('reportTotalHolding').innerText = holdingText;
            adjustFontSize('reportTotalHolding', holdingText, 'text-2xl');
            
            const savings = data.aluguel.totalTax - data.holding.totalTax;
            const savingsEl = document.getElementById('reportSavings');
            const savingsText = savings > 0 ? formatCurrency(savings) : formatCurrency(Math.abs(savings)) + ' (Vantagem PF)';
            
            savingsEl.innerText = savingsText;
            if(savings > 0) {
                savingsEl.className = "font-black text-emerald-700 tracking-tight mt-1 whitespace-nowrap";
                adjustFontSize('reportSavings', savingsText, 'text-3xl');
            } else {
                savingsEl.className = "font-black text-red-600 tracking-tight mt-1 whitespace-nowrap";
                adjustFontSize('reportSavings', savingsText, 'text-3xl');
            }

            const ctxReportEl = document.getElementById('chartReport');
            if(!ctxReportEl) return;
            const ctxReport = ctxReportEl.getContext('2d');
            
            if (chartReportInstance) chartReportInstance.destroy();
            
            // Calculando Carga Tributária % para o Relatório (igual ao dashboard)
            let rateA_Report = [], rateH_Report = [];
            data.years.forEach((y, i) => {
                let gross = data.grossRevenue[i];
                rateA_Report.push(gross > 0 ? (data.aluguel.taxArr[i] / gross) * 100 : 0);
                rateH_Report.push(gross > 0 ? (data.holding.taxArr[i] / gross) * 100 : 0);
            });

            chartReportInstance = new Chart(ctxReport, {
                type: 'line',
                data: {
                    labels: data.years,
                    datasets: [
                        { 
                            label: 'Aluguel PF %', 
                            data: rateA_Report, 
                            borderColor: '#dc2626', 
                            backgroundColor: '#dc2626', 
                            tension: 0.3, 
                            pointRadius: 4, 
                            pointHoverRadius: 6 
                        },
                        { 
                            label: 'Holding PJ %', 
                            data: rateH_Report, 
                            borderColor: '#2563eb', 
                            backgroundColor: '#2563eb', 
                            borderWidth: 3, 
                            tension: 0.3, 
                            pointRadius: 5, 
                            pointHoverRadius: 7 
                        }
                    ]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8, callbacks: { label: (c) => c.dataset.label + ': ' + formatPercent(c.raw) } },
                        datalabels: {
                            align: 'top',
                            anchor: 'end',
                            offset: 4,
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            borderRadius: 4,
                            borderWidth: 1,
                            borderColor: (ctx) => ctx.dataset.borderColor,
                            color: (ctx) => ctx.dataset.borderColor,
                            font: { weight: 'bold', size: 10 },
                            formatter: (value) => value.toFixed(1) + '%',
                        }
                    },
                    layout: { padding: { top: 25, right: 15, left: 15 } },
                    scales: { 
                        y: { ticks: { callback: (v) => v.toFixed(1) + '%' }, grid: { borderDash: [4, 4], color: '#f1f5f9' }, grace: '10%' },
                        x: { grid: { display: false } }
                    }
                }
            });

            let tableHtml = '';
            data.years.forEach((year, i) => {
                let eco = data.aluguel.taxArr[i] - data.holding.taxArr[i];
                let ecoClass = eco > 0 ? 'text-emerald-700 font-bold bg-emerald-50/30' : 'text-red-600 font-medium bg-red-50/30';
                
                // Linha Principal (Anual)
                tableHtml += `
                    <tr class="hover:bg-slate-50 transition print-avoid-break">
                        <td class="p-3 border-b border-slate-200 font-black text-slate-700">${year}</td>
                        <td class="p-3 border-b border-slate-200 text-right font-medium text-slate-600">${formatCurrency(data.grossRevenue[i])}</td>
                        <td class="p-3 border-b border-slate-200 text-right font-semibold text-red-700">${formatCurrency(data.aluguel.taxArr[i])}</td>
                        <td class="p-3 border-b border-slate-200 text-right font-semibold text-blue-700">${formatCurrency(data.holding.taxArr[i])}</td>
                        <td class="p-3 border-b border-slate-200 text-right ${ecoClass}">${formatCurrency(eco)}</td>
                    </tr>
                `;

                // Linha Indentada (Média Mensal)
                let avgEcoClass = eco > 0 ? 'text-emerald-600' : 'text-red-500';
                tableHtml += `
                    <tr class="hover:bg-slate-50/50 transition print-avoid-break text-[11px] text-slate-500 italic">
                        <td class="p-2 border-b border-slate-100 pl-8">↳ Média Mensal</td>
                        <td class="p-2 border-b border-slate-100 text-right">${formatCurrency(data.grossRevenue[i] / 12)}</td>
                        <td class="p-2 border-b border-slate-100 text-right">${formatCurrency(data.aluguel.taxArr[i] / 12)}</td>
                        <td class="p-2 border-b border-slate-100 text-right">${formatCurrency(data.holding.taxArr[i] / 12)}</td>
                        <td class="p-2 border-b border-slate-100 text-right ${avgEcoClass}">${formatCurrency(eco / 12)}</td>
                    </tr>
                `;
            });
            const reportTableBody = document.getElementById('reportTableBody');
            if(reportTableBody) reportTableBody.innerHTML = tableHtml;

            // Pré-calculando vantagem média mensal por ano para suavizar o gráfico trimestral
            const avgAdvantageByYear = {};
            data.years.forEach((year, i) => {
                avgAdvantageByYear[year] = (data.aluguel.taxArr[i] - data.holding.taxArr[i]) / 12;
            });
            
            let monthlyHtml = '';
            data.monthlyData.forEach(row => {
                // Usando a média anual para a coluna de vantagem como solicitado
                const yearOfRow = row.date.split('/')[1];
                const vEcoMediaMensal = avgAdvantageByYear[yearOfRow] || 0;
                const ecoColor = vEcoMediaMensal > 0 ? 'text-emerald-600 font-bold bg-emerald-50/20' : 'text-red-500 font-medium bg-red-50/20';
                
                monthlyHtml += `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition print-avoid-break">
                        <td class="p-1.5 font-mono font-bold text-slate-600 text-center">${row.date}</td>
                        <td class="p-1.5 text-right font-medium bg-slate-50/50">${formatCurrency(row.gross)}</td>
                        
                        <td class="p-1.5 text-right text-slate-500">${formatCurrency(row.aluguel.irpf)}</td>
                        <td class="p-1.5 text-right text-slate-500">${formatCurrency(row.aluguel.pfIbs + row.aluguel.pfCbs)}</td>
                        <td class="p-1.5 text-right font-bold text-red-700 bg-red-50/30">${formatCurrency(row.aluguel.tax)}</td>
                        
                        <td class="p-1.5 text-right text-slate-500">${formatCurrency(row.holding.pisCofins)}</td>
                        <td class="p-1.5 text-right text-slate-500">${formatCurrency(row.holding.ibs + row.holding.cbs)}</td>
                        <td class="p-1.5 text-right text-slate-500">${formatCurrency(row.holding.irpj + row.holding.csll + row.holding.adicional)}</td>
                        <td class="p-1.5 text-right font-bold text-blue-700 bg-blue-50/30">${formatCurrency(row.holding.tax)}</td>
                        
                        <td class="p-1.5 text-right ${ecoColor}">${formatCurrency(vEcoMediaMensal)}</td>
                    </tr>
                `;
            });
            const reportMonthlyDetailBody = document.getElementById('reportMonthlyDetailBody');
            if(reportMonthlyDetailBody) reportMonthlyDetailBody.innerHTML = monthlyHtml;
        }

        function renderAnnualTable(data) {
             let html = `
            <thead class="text-xs uppercase font-bold tracking-wider border-b-2 border-slate-200 shadow-sm">
                <tr>
                    <th class="col-sticky-left bg-white border-r border-slate-200 z-20 px-4 py-3 text-slate-500">Ano</th>
                    <th class="text-right border-r border-slate-200 min-w-[120px] px-4 py-3 bg-slate-50 text-slate-600">Faturamento</th>
                    <th colspan="2" class="text-center bg-red-100/80 border-r border-red-200 text-red-800 px-4 py-3"><i class="fa-solid fa-house-user mr-1"></i> Aluguel PF</th>
                    <th colspan="2" class="text-center bg-blue-100/80 text-blue-800 px-4 py-3"><i class="fa-solid fa-building mr-1"></i> Holding PJ</th>
                </tr>
                <tr class="text-[10px]">
                    <th class="col-sticky-left bg-white border-r border-slate-200 top-[45px] z-20 px-4 py-2"></th>
                    <th class="border-r border-slate-200 top-[45px] px-4 py-2 bg-slate-50"></th>
                    
                    <th class="text-right text-red-700 bg-red-50 px-3 py-2 border-r border-red-100">Impostos (R$)</th>
                    <th class="text-right text-red-700 bg-red-50 border-r border-slate-200 px-3 py-2">Carga %</th>
                    
                    <th class="text-right text-blue-700 bg-blue-50 px-3 py-2 border-r border-blue-100">Impostos (R$)</th>
                    <th class="text-right text-blue-700 bg-blue-50 px-3 py-2">Carga %</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white">`;

            data.years.forEach((year, i) => {
                let gross = data.grossRevenue[i];
                let aTax = data.aluguel.taxArr[i];
                let hTax = data.holding.taxArr[i];

                html += `
                <tr class="hover:bg-slate-50 transition group">
                    <td class="col-sticky-left bg-white font-bold text-slate-700 border-r border-slate-100 group-hover:bg-slate-50 px-4 py-3 shadow-sm">${year}</td>
                    <td class="text-right font-medium text-slate-600 border-r border-slate-100 px-4 py-3 bg-slate-50/50">${formatCurrency(gross)}</td>
                    
                    <td class="text-right font-semibold text-red-700 bg-red-50/30 border-r border-red-50 px-4 py-3">${formatCurrency(aTax)}</td>
                    <td class="text-right font-bold text-red-800 bg-red-100/40 border-r border-slate-200 px-4 py-3">${formatPercent(gross > 0 ? (aTax/gross)*100 : 0)}</td>

                    <td class="text-right font-semibold text-blue-700 bg-blue-50/30 border-r border-blue-50 px-4 py-3">${formatCurrency(hTax)}</td>
                    <td class="text-right font-bold text-blue-800 bg-blue-100/40 px-4 py-3">${formatPercent(gross > 0 ? (hTax/gross)*100 : 0)}</td>
                </tr>`;
            });
            document.getElementById('annualTable').innerHTML = html + `</tbody>`;
        }

        function renderModuleTables(data) {
            const createRow = (row, typeData, hoverBg, type) => {
                let extraCols = '';
                const rowClickAttr = `onclick="openDetailModal(${row.id}, '${type}')"`;
                const cursorClass = 'cursor-pointer cursor-pointer-row';

                if(type === 'rural') {
                     extraCols = `
                     <td class="px-4 py-2 text-right font-medium text-slate-500 border-r border-slate-50">${formatCurrency(row.rural.icms)}</td>
                     <td class="px-4 py-2 text-right font-medium text-slate-500 border-r border-slate-50">${formatCurrency(row.rural.cbs)}</td>
                     <td class="px-4 py-2 text-right font-semibold text-orange-500 bg-orange-50/30 border-r border-slate-50">${formatCurrency(row.rural.ibs)}</td>
                     <td class="px-4 py-2 text-right font-medium text-slate-500 border-r border-slate-50">${formatCurrency(row.rural.fun)}</td>`;
                } else if (type === 'aluguel') {
                     extraCols = `
                     <td class="px-4 py-2 text-right font-bold text-blue-600 bg-blue-50/30 border-r border-slate-50">${formatCurrency(row.aluguel.irpf)}</td>
                     <td class="px-4 py-2 text-right font-semibold text-orange-500 bg-orange-50/30 border-r border-slate-50">${formatCurrency(row.aluguel.pfIbs)}</td>
                     <td class="px-4 py-2 text-right font-semibold text-orange-500 bg-orange-50/30 border-r border-slate-50">${formatCurrency(row.aluguel.pfCbs)}</td>`;
                } else {
                     extraCols = `
                     <td class="px-4 py-2 text-right font-medium text-slate-500 border-r border-slate-50">${formatCurrency(row.holding.pisCofins)}</td>
                     <td class="px-4 py-2 text-right font-semibold text-orange-500 bg-orange-50/30 border-r border-slate-50">${formatCurrency(row.holding.ibs)}</td>
                     <td class="px-4 py-2 text-right font-semibold text-orange-500 bg-orange-50/30 border-r border-slate-50">${formatCurrency(row.holding.cbs)}</td>
                     <td class="px-4 py-2 text-right font-medium border-r border-slate-50 ${row.holding.irpj > 0 ? 'font-bold text-blue-700 bg-blue-50/50' : 'text-slate-400 opacity-60'}">${formatCurrency(row.holding.irpj)}</td>
                     <td class="px-4 py-2 text-right font-medium border-r border-slate-50 ${row.holding.adicional > 0 ? 'font-bold text-blue-700 bg-blue-50/50' : 'text-slate-400 opacity-60'}">${formatCurrency(row.holding.adicional)}</td>
                     <td class="px-4 py-2 text-right font-medium border-r border-slate-50 ${row.holding.csll > 0 ? 'font-bold text-blue-700 bg-blue-50/50' : 'text-slate-400 opacity-60'}">${formatCurrency(row.holding.csll)}</td>`;
                }

                return `
                <tr class="${hoverBg} border-b border-slate-100 group transition ${cursorClass}" ${rowClickAttr}>
                    <td class="px-4 py-3 col-sticky-left bg-white font-mono font-bold text-slate-600 border-r border-slate-100 shadow-sm"><i class="fa-solid fa-magnifying-glass-plus text-[10px] mr-2 text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"></i>${row.date}</td>
                    <td class="px-4 py-3 text-right font-medium text-slate-600 border-r border-slate-100 bg-slate-50/30">${formatCurrency(row.gross)}</td>
                    ${extraCols}
                    <td class="px-4 py-3 text-right font-black text-red-700 bg-red-50/80">${formatCurrency(typeData.tax)}</td>
                </tr>`;
            }

            let rHtml = '', aHtml = '', hHtml = '';
            
            data.monthlyData.forEach(row => {
                rHtml += createRow(row, row.rural, 'hover:bg-green-50', 'rural');
                aHtml += createRow(row, row.aluguel, 'hover:bg-red-50', 'aluguel');
                hHtml += createRow(row, row.holding, 'hover:bg-blue-50', 'holding');
            });

            const ruralMonthlyBody = document.getElementById('ruralMonthlyBody');
            if (ruralMonthlyBody) ruralMonthlyBody.innerHTML = rHtml;
            
            document.getElementById('aluguelMonthlyBody').innerHTML = aHtml;
            document.getElementById('holdingMonthlyBody').innerHTML = hHtml;
        }

        function renderRuralAnnualReport(data) {
            const container = document.getElementById('ruralAnnualReportBody');
            if (!container) return;
            
            let html = `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div class="p-4 border-b border-slate-100 bg-green-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-green-800 text-sm"><i class="fa-solid fa-calculator text-green-600 mr-2"></i>Memória de Cálculo IRPF Rural (Anual)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-50 text-slate-600 font-bold border-b">
                                <tr>
                                    <th class="px-4 py-2">Ano</th>
                                    <th class="px-4 py-2">Método</th>
                                    <th class="px-4 py-2 text-right">Fat. Bruto</th>
                                    <th class="px-4 py-2 text-right">Deduções/Despesas</th>
                                    <th class="px-4 py-2 text-right">Base de Cálculo</th>
                                    <th class="px-4 py-2 text-right text-red-600">IRPF Anual</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
            `;
            
            data.rural.annualReports.forEach(rep => {
                html += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2 font-bold">${rep.year}</td>
                        <td class="px-4 py-2">${rep.method}</td>
                        <td class="px-4 py-2 text-right">${formatCurrency(rep.gross)}</td>
                        <td class="px-4 py-2 text-right text-red-500">-${formatCurrency(rep.deduction + rep.simplifiedDiscount)}</td>
                        <td class="px-4 py-2 text-right font-semibold">${formatCurrency(rep.baseFinal)}</td>
                        <td class="px-4 py-2 text-right font-bold text-red-600">${formatCurrency(rep.tax)}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div></div>`;
            container.innerHTML = html;
        }

        function updateCharts(data) {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';

            let rateA = [], rateH = [];
            data.years.forEach((y, i) => {
                let gross = data.grossRevenue[i];
                rateA.push(gross > 0 ? (data.aluguel.taxArr[i] / gross) * 100 : 0);
                rateH.push(gross > 0 ? (data.holding.taxArr[i] / gross) * 100 : 0);
            });

            const ctxWealthEl = document.getElementById('chartWealth');
            if (ctxWealthEl) {
                const ctxWealth = ctxWealthEl.getContext('2d');
                if (chartWealthInstance) chartWealthInstance.destroy();

                chartWealthInstance = new Chart(ctxWealth, {
                    type: 'line',
                    data: {
                        labels: data.years,
                        datasets: [
                            { label: 'Aluguel PF %', data: rateA, borderColor: '#dc2626', backgroundColor: '#dc2626', tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                            { label: 'Holding PJ %', data: rateH, borderColor: '#2563eb', backgroundColor: '#2563eb', borderWidth: 3, tension: 0.3, pointRadius: 5, pointHoverRadius: 7 }
                        ]
                    },
                    plugins: [ChartDataLabels],
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { 
                            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                            tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8, callbacks: { label: (c) => c.dataset.label + ': ' + formatPercent(c.raw) } },
                            datalabels: {
                                align: function(context) {
                                    var value = context.dataset.data[context.dataIndex];
                                    var allValues = [];
                                    context.chart.data.datasets.forEach(function(dataset) {
                                        allValues.push(dataset.data[context.dataIndex]);
                                    });
                                    allValues.sort(function(a, b) { return b - a; });
                                    var rank = allValues.indexOf(value);
                                    
                                    if (rank === 0) return 'top';
                                    if (rank === allValues.length - 1) return 'bottom';
                                    var diffUp = Math.abs(allValues[rank-1] - value);
                                    var diffDown = Math.abs(value - allValues[rank+1]);
                                    return diffUp < diffDown ? 'bottom' : 'top';
                                },
                                anchor: function(context) {
                                    var value = context.dataset.data[context.dataIndex];
                                    var allValues = [];
                                    context.chart.data.datasets.forEach(function(dataset) {
                                        allValues.push(dataset.data[context.dataIndex]);
                                    });
                                    allValues.sort(function(a, b) { return b - a; });
                                    var rank = allValues.indexOf(value);
                                    
                                    var position = 'top';
                                    if (rank === 0) position = 'top';
                                    else if (rank === allValues.length - 1) position = 'bottom';
                                    else {
                                        var diffUp = Math.abs(allValues[rank-1] - value);
                                        var diffDown = Math.abs(value - allValues[rank+1]);
                                        position = diffUp < diffDown ? 'bottom' : 'top';
                                    }
                                    return position === 'top' ? 'end' : 'start';
                                },
                                offset: 4,
                                backgroundColor: 'rgba(255, 255, 255, 0.8)',
                                borderRadius: 4,
                                borderWidth: 1,
                                borderColor: (ctx) => ctx.dataset.borderColor,
                                color: (ctx) => ctx.dataset.borderColor,
                                font: { weight: 'bold', size: 10 },
                                formatter: (value) => value.toFixed(1) + '%',
                            }
                        },
                        layout: { padding: { top: 25, right: 15, left: 15 } },
                        scales: { 
                            y: { ticks: { callback: (v) => v.toFixed(1) + '%' }, grid: { borderDash: [4, 4], color: '#f1f5f9' }, grace: '10%' },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            const ctxAnnualSummaryEl = document.getElementById('chartAnnualSummary');
            if(ctxAnnualSummaryEl) {
                const ctxAnnualSummary = ctxAnnualSummaryEl.getContext('2d');
                
                if (chartAnnualSummaryInstance) chartAnnualSummaryInstance.destroy();

                let annualDatasets = [];
                let annualYAxisTitle = '';
                let annualTickCallback = null;
                
                // Calculando Economia Acumulada para o gráfico funcional
                let cumulativeEconomy = [];
                let currentSum = 0;
                data.years.forEach((y, i) => {
                    currentSum += (data.aluguel.taxArr[i] - data.holding.taxArr[i]);
                    cumulativeEconomy.push(currentSum);
                });

                if (chartAnnualSummaryMode === 'value') {
                    annualYAxisTitle = 'Tributos e Economia (R$)';
                    annualTickCallback = (v) => 'R$ ' + (v >= 1000000 ? (v/1000000).toFixed(1) + 'M' : (v/1000).toFixed(0) + 'k');
                    annualDatasets = [
                        { 
                            label: 'Imposto PF (Aluguel)', 
                            data: data.aluguel.taxArr, 
                            backgroundColor: '#fca5a5', 
                            borderColor: '#dc2626', 
                            borderWidth: 1,
                            borderRadius: 4,
                            order: 3
                        },
                        { 
                            label: 'Imposto PJ (Holding)', 
                            data: data.holding.taxArr, 
                            backgroundColor: '#93c5fd', 
                            borderColor: '#2563eb', 
                            borderWidth: 1,
                            borderRadius: 4,
                            order: 4
                        },
                        {
                            label: 'Economia Acumulada',
                            data: cumulativeEconomy,
                            type: 'line',
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4,
                            yAxisID: 'y',
                            order: 1
                        },
                        { 
                            label: 'Faturamento Bruto', 
                            data: data.grossRevenue, 
                            type: 'line',
                            borderColor: '#94a3b8',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointStyle: false,
                            yAxisID: 'yRevenue',
                            order: 2
                        }
                    ];
                } else {
                    annualYAxisTitle = 'Carga Tributária (%)';
                    annualTickCallback = (v) => v + '%';
                    annualDatasets = [
                        { 
                            label: 'Carga Aluguel %', 
                            data: rateA, 
                            backgroundColor: '#dc2626', 
                            borderColor: '#dc2626', 
                            borderWidth: 1, 
                            borderRadius: 4,
                            order: 1 
                        },
                        { 
                            label: 'Carga Holding %', 
                            data: rateH, 
                            backgroundColor: '#2563eb', 
                            borderColor: '#2563eb', 
                            borderWidth: 1, 
                            borderRadius: 4,
                            order: 2 
                        }
                    ];
                }

                chartAnnualSummaryInstance = new Chart(ctxAnnualSummary, {
                    type: 'bar',
                    data: {
                        labels: data.years,
                        datasets: annualDatasets
                    },
                    plugins: [ChartDataLabels],
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        layout: { padding: { top: 40, right: 20 } }, 
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    boxWidth: 10, 
                                    font: { size: 10 },
                                    padding: 15
                                } 
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                padding: 12,
                                cornerRadius: 8,
                                titleFont: { size: 14, weight: 'bold' },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (chartAnnualSummaryMode === 'percent') {
                                            label += context.raw.toFixed(2) + '%';
                                        } else {
                                            label += formatCurrency(context.raw);
                                        }
                                        return label;
                                    },
                                    afterBody: function(items) {
                                        if (chartAnnualSummaryMode === 'value') {
                                            const yearIdx = items[0].dataIndex;
                                            const pf = data.aluguel.taxArr[yearIdx];
                                            const pj = data.holding.taxArr[yearIdx];
                                            const eco = pf - pj;
                                            const perc = data.grossRevenue[yearIdx] > 0 ? (eco / data.grossRevenue[yearIdx]) * 100 : 0;
                                            return [
                                                '',
                                                `Vantagem no Ano: ${formatCurrency(eco)}`,
                                                `Eficiência Holding: +${perc.toFixed(1)}% do Fat.`
                                            ];
                                        }
                                        return [];
                                    }
                                }
                            },
                            datalabels: {
                                display: (ctx) => {
                                    // Mostra apenas para os impostos e economia, não para o faturamento bruto para não poluir
                                    if (ctx.dataset.label === 'Faturamento Bruto') return false;
                                    return ctx.dataset.data[ctx.dataIndex] > 0;
                                },
                                anchor: 'end',
                                align: 'top',
                                color: (ctx) => ctx.dataset.borderColor || '#475569',
                                font: { weight: 'bold', size: 9 },
                                offset: 4,
                                formatter: function(value, ctx) {
                                    if (chartAnnualSummaryMode === 'percent') {
                                        return value.toFixed(1) + '%';
                                    } else {
                                        if (ctx.dataset.type === 'line') return ''; // Evita sobreposição na linha
                                        if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return (value/1000).toFixed(0) + 'k';
                                        return value.toFixed(0);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear', display: true, position: 'left',
                                title: { display: true, text: annualYAxisTitle, font: { weight: 'bold' } },
                                ticks: { callback: annualTickCallback },
                                grid: { borderDash: [4, 4] },
                                beginAtZero: true,
                                grace: '15%' 
                            },
                            yRevenue: {
                                type: 'linear',
                                display: chartAnnualSummaryMode === 'value',
                                position: 'right',
                                title: { display: true, text: 'Faturamento Bruto', font: { weight: 'bold' } },
                                grid: { drawOnChartArea: false },
                                ticks: { callback: (v) => 'R$ ' + (v/1000).toFixed(0) + 'k' },
                                beginAtZero: true
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }


            const chartRuralEvolEl = document.getElementById('chartRuralEvolution');
            if (chartRuralEvolEl) {
                updateStackedChart('chartRuralEvolution', data.years, [
                    { label: 'ICMS', data: data.rural.annualDetails.icms, backgroundColor: '#10b981', yAxisID: chartViewModes.rural === 'value' ? 'y' : 'y' }, 
                    { label: 'Funrural', data: data.rural.annualDetails.fun, backgroundColor: '#db2777', yAxisID: chartViewModes.rural === 'value' ? 'y' : 'y' },
                    { label: 'CBS', data: data.rural.annualDetails.cbs, backgroundColor: '#f59e0b', yAxisID: chartViewModes.rural === 'value' ? 'y' : 'y' }, 
                    { label: 'IBS', data: data.rural.annualDetails.ibs, backgroundColor: '#8b5cf6', yAxisID: chartViewModes.rural === 'value' ? 'y' : 'y' }, 
                    { label: 'IRPF Anual', data: data.rural.annualDetails.annualIrpf, backgroundColor: '#ef4444', yAxisID: chartViewModes.rural === 'value' ? 'y' : 'y' } 
                ], data.grossRevenue, chartViewModes.rural, 'chartRuralEvolutionInstance');
            }

            updateStackedChart('chartAluguelEvolution', data.years, [
                { label: 'IRPF (Carnê)', data: data.aluguel.annualDetails.irpf, backgroundColor: '#ef4444', yAxisID: chartViewModes.aluguel === 'value' ? 'y' : 'y' }, 
                { label: 'IBS', data: data.aluguel.annualDetails.ibs, backgroundColor: '#8b5cf6', yAxisID: chartViewModes.aluguel === 'value' ? 'y' : 'y' }, 
                { label: 'CBS', data: data.aluguel.annualDetails.cbs, backgroundColor: '#f59e0b', yAxisID: chartViewModes.aluguel === 'value' ? 'y' : 'y' } 
            ], data.grossRevenue, chartViewModes.aluguel, 'chartAluguelEvolutionInstance');

            updateStackedChart('chartHoldingEvolution', data.years, [
                { label: 'PIS/COFINS', data: data.holding.annualDetails.pis, backgroundColor: '#64748b', yAxisID: chartViewModes.holding === 'value' ? 'y' : 'y' }, 
                { label: 'IRPJ', data: data.holding.annualDetails.ir, backgroundColor: '#3b82f6', yAxisID: chartViewModes.holding === 'value' ? 'y' : 'y' }, 
                { label: 'CSLL', data: data.holding.annualDetails.cs, backgroundColor: '#0ea5e9', yAxisID: chartViewModes.holding === 'value' ? 'y' : 'y' }, 
                { label: 'Adicional', data: data.holding.annualDetails.ad, backgroundColor: '#1d4ed8', yAxisID: chartViewModes.holding === 'value' ? 'y' : 'y' }, 
                { label: 'IBS', data: data.holding.annualDetails.hIbs, backgroundColor: '#8b5cf6', yAxisID: chartViewModes.holding === 'value' ? 'y' : 'y' }, 
                { label: 'CBS', data: data.holding.annualDetails.hCbs, backgroundColor: '#f59e0b', yAxisID: chartViewModes.holding === 'value' ? 'y' : 'y' } 
            ], data.grossRevenue, chartViewModes.holding, 'chartHoldingEvolutionInstance');
        }

        function updateStackedChart(canvasId, labels, barDatasets, grossRevenue, mode, instanceVarName) {
            const ctxEl = document.getElementById(canvasId);
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            
            if (window[instanceVarName]) {
                window[instanceVarName].destroy();
            }

            let datasets = barDatasets;
            if (mode === 'percent') {
                datasets = barDatasets.map(ds => ({
                    ...ds,
                    data: ds.data.map((val, i) => grossRevenue[i] > 0 ? (val / grossRevenue[i]) * 100 : 0)
                }));
            }

            window[instanceVarName] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (mode === 'percent') {
                                        label += context.raw.toFixed(2) + '%';
                                    } else {
                                        label += formatCurrency(context.raw);
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                return context.datasetIndex === context.chart.data.datasets.length - 1;
                            },
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                let sum = 0;
                                context.chart.data.datasets.forEach(dataset => {
                                    sum += dataset.data[context.dataIndex];
                                });
                                if (mode === 'percent') {
                                    return sum.toFixed(1) + '%';
                                } else {
                                    return 'R$ ' + (sum/1000).toFixed(0) + 'k';
                                }
                            },
                            color: '#334155',
                            font: { weight: 'bold', size: 11 }
                        }
                    },
                    layout: { padding: { top: 30 } },
                    scales: { 
                        x: { stacked: true, grid: { display: false } }, 
                        y: { 
                            stacked: true, 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true, 
                            grid: { borderDash: [4, 4] },
                            title: { display: true, text: mode === 'value' ? 'Valor (R$)' : 'Carga (%)' },
                            ticks: { callback: (v) => mode === 'percent' ? v + '%' : 'R$ ' + (v/1000).toFixed(0) + 'k' },
                            grace: '10%'
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        const buildAccordionStep = (number, title, contentHTML, icon, iconBgColor) => `
            <details class="group mb-4 bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden" open>
                <summary class="flex items-center justify-between p-4 cursor-pointer bg-slate-50/80 hover:bg-slate-100 transition-colors list-none border-b border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg ${iconBgColor} flex items-center justify-center font-bold shadow-sm shrink-0">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <h4 class="font-bold text-slate-700 text-sm tracking-wide uppercase">${number}. ${title}</h4>
                    </div>
                    <i class="fa-solid fa-chevron-down text-slate-400 group-open:rotate-180 transition-transform duration-300"></i>
                </summary>
                <div class="p-5 bg-white text-sm">
                    ${contentHTML}
                </div>
            </details>
        `;

        const summaryTotal = (label, val, bgClass='bg-slate-800', textClass='text-white') => `
            <div class="flex flex-col sm:flex-row justify-between sm:items-center p-5 mt-5 rounded-2xl shadow-xl ${bgClass} ${textClass} border border-slate-700/50">
                <span class="text-sm font-bold uppercase tracking-widest flex items-center gap-2 mb-1 sm:mb-0"><i class="fa-solid fa-receipt opacity-70"></i> ${label}</span>
                <span class="text-2xl font-black tracking-tight">${formatCurrency(val)}</span>
            </div>
        `;

        function openDetailModal(dataIndex, type) {
            if(!globalCalculationData) return;
            const row = globalCalculationData.monthlyData[dataIndex];
            const modal = document.getElementById('detailMonthModal');
            const title = document.getElementById('detailModalTitle');
            const sub = document.getElementById('detailModalSubtitle');
            const grossDisplay = document.getElementById('detailModalGross');
            const content = document.getElementById('detailModalContent');
            const iconContainer = document.getElementById('detailModalIcon');

            sub.innerText = `Competência: ${row.date}`;
            grossDisplay.innerText = `Fat Bruto: ${formatCurrency(row.gross)}`;
            content.innerHTML = '';

            let detailsHTML = '';

            if (type === 'rural') {
                title.innerText = 'Produtor Rural PF';
                iconContainer.className = "w-12 h-12 rounded-xl flex items-center justify-center text-green-700 bg-green-100 shadow-inner text-2xl ring-1 ring-green-200";
                iconContainer.innerHTML = '<i class="fa-solid fa-wheat-awn"></i>';

                detailsHTML += buildAccordionStep(1, 'Tributos Indiretos (Receita Mensal)', `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                            <div>
                                <div class="font-bold text-slate-700">ICMS Estadual</div>
                                <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.rural.icmsRate)}</div>
                            </div>
                            <span class="font-bold text-slate-800">${formatCurrency(row.rural.icms)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                            <div>
                                <div class="font-bold text-slate-700">Funrural</div>
                                <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.rural.funRate)}</div>
                            </div>
                            <span class="font-bold text-slate-800">${formatCurrency(row.rural.fun)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                            <div>
                                <div class="font-bold text-slate-700">CBS (Federal)</div>
                                <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.rural.cbsRate)}</div>
                            </div>
                            <span class="font-bold text-slate-800">${formatCurrency(row.rural.cbs)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <div>
                                <div class="font-bold text-slate-700">IBS (Est/Mun)</div>
                                <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.rural.ibsRate)}</div>
                            </div>
                            <span class="font-bold text-slate-800">${formatCurrency(row.rural.ibs)}</span>
                        </div>
                    </div>
                `, 'fa-seedling', 'bg-green-100 text-green-700');

                if(row.rural.irpfAnnualShare > 0) {
                    detailsHTML += buildAccordionStep(2, 'IRPF Rateado (Ajuste Anual)', `
                        <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg text-xs text-blue-800 mb-2">
                            Como o produtor rural apura IRPF anualmente, este valor representa o rateio do imposto calculado sobre o ano inteiro alocado neste mês.
                        </div>
                        <div class="flex justify-between items-center py-3 font-bold text-slate-700 border-t border-slate-200 mt-2 px-2 bg-slate-50 rounded">
                            <span>Valor Adicionado neste Mês</span>
                            <span class="text-red-600 text-lg">${formatCurrency(row.rural.irpfAnnualShare)}</span>
                        </div>
                    `, 'fa-file-invoice-dollar', 'bg-blue-100 text-blue-600');
                }
                
                detailsHTML += summaryTotal('Total Apurado no Mês', row.rural.tax, 'bg-slate-800', 'text-white');

            } else if (type === 'aluguel') {
                title.innerText = 'Aluguel Pessoa Física';
                iconContainer.className = "w-12 h-12 rounded-xl flex items-center justify-center text-red-700 bg-red-100 shadow-inner text-2xl ring-1 ring-red-200";
                iconContainer.innerHTML = '<i class="fa-solid fa-house-user"></i>';

                detailsHTML += buildAccordionStep(1, 'Faturamento e Base de Cálculo', `
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-600">Faturamento Bruto</span>
                        <span class="font-bold text-slate-800">${formatCurrency(row.gross)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-600">Dedução Simplificada (Opcional)</span>
                        <span class="font-bold text-red-500">- ${formatCurrency(row.aluguel.irpfDescSimplificadoVal || 0)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 bg-slate-50 rounded-lg px-3 mt-3 border border-slate-200">
                        <span class="font-bold text-slate-700">Base de Cálculo do IRPF</span>
                        <span class="font-black text-blue-600 text-lg">${formatCurrency(row.aluguel.irpfBase)}</span>
                    </div>
                `, 'fa-calculator', 'bg-blue-100 text-blue-600');

                detailsHTML += buildAccordionStep(2, 'Cálculo do IRPF (Carnê-Leão Mensal)', `
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <div class="text-[10px] text-slate-500 uppercase tracking-wide">Alíquota da Tabela</div>
                            <div class="font-bold text-slate-800 text-lg">${formatPercent(row.aluguel.irpfBracketRate)}</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <div class="text-[10px] text-slate-500 uppercase tracking-wide">Parcela a Deduzir</div>
                            <div class="font-bold text-slate-800 text-lg">${formatCurrency(row.aluguel.irpfBracketDed)}</div>
                        </div>
                    </div>
                    <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 text-xs text-blue-800 font-mono tracking-tight flex flex-col gap-1">
                        <span class="text-[10px] uppercase font-bold text-blue-600 mb-1">Fórmula de Cálculo:</span>
                        <span>(Base de Cálculo × Alíquota) - Dedução</span>
                        <span class="font-black text-sm mt-1 text-slate-800">(${formatCurrency(row.aluguel.irpfBase)} × ${formatPercent(row.aluguel.irpfBracketRate)}) - ${formatCurrency(row.aluguel.irpfBracketDed)}</span>
                    </div>
                    <div class="flex justify-between items-center py-3 mt-3 border-t border-slate-200">
                        <span class="font-bold text-slate-700">Imposto de Renda Apurado</span>
                        <span class="font-black text-red-600 text-lg">${formatCurrency(row.aluguel.irpf)}</span>
                    </div>
                `, 'fa-file-signature', 'bg-red-100 text-red-600');

                detailsHTML += buildAccordionStep(3, 'Tributos Indiretos (IBS/CBS sobre Aluguel)', `
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <div>
                            <div class="font-bold text-slate-700">IBS (Est/Mun)</div>
                            <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.aluguel.pfIbsRate)}</div>
                        </div>
                        <span class="font-bold text-orange-600">${formatCurrency(row.aluguel.pfIbs)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <div>
                            <div class="font-bold text-slate-700">CBS (Federal)</div>
                            <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.aluguel.pfCbsRate)}</div>
                        </div>
                        <span class="font-bold text-orange-600">${formatCurrency(row.aluguel.pfCbs)}</span>
                    </div>
                `, 'fa-tags', 'bg-orange-100 text-orange-600');

                detailsHTML += summaryTotal('Total Tributos Apurados', row.aluguel.tax, 'bg-red-900', 'text-white');

            } else {
                title.innerText = 'Holding Patrimonial (PJ)';
                iconContainer.className = "w-12 h-12 rounded-xl flex items-center justify-center text-blue-700 bg-blue-100 shadow-inner text-2xl ring-1 ring-blue-200";
                iconContainer.innerHTML = '<i class="fa-solid fa-building"></i>';

                detailsHTML += buildAccordionStep(1, 'Impostos Indiretos (Sobre o Faturamento do Mês)', `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                            <div>
                                <div class="font-bold text-slate-700">PIS / COFINS (Legado)</div>
                                <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.holding.pisCofinsRate)}</div>
                            </div>
                            <span class="font-bold text-slate-800">${formatCurrency(row.holding.pisCofins)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                            <div>
                                <div class="font-bold text-slate-700">IBS (Novo)</div>
                                <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.holding.ibsRate)}</div>
                            </div>
                            <span class="font-bold text-orange-600">${formatCurrency(row.holding.ibs)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <div>
                                <div class="font-bold text-slate-700">CBS (Novo)</div>
                                <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.gross)} × Alíq: ${formatPercent(row.holding.cbsRate)}</div>
                            </div>
                            <span class="font-bold text-orange-600">${formatCurrency(row.holding.cbs)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-3 mt-3 bg-slate-50 rounded-lg px-4 border border-slate-200">
                        <span class="font-bold text-slate-700">Subtotal de Indiretos</span>
                        <span class="font-black text-slate-800 text-lg">${formatCurrency(row.holding.pisCofins + row.holding.ibs + row.holding.cbs)}</span>
                    </div>
                `, 'fa-file-invoice', 'bg-slate-100 text-slate-600');

                if (row.holding.isQuarterMonth) {
                    detailsHTML += buildAccordionStep(2, 'Apuração Trimestral (Impostos sobre Lucro Presumido)', `
                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                            <span class="text-slate-600">Faturamento Acumulado (Trimestre)</span>
                            <span class="font-bold text-slate-800">${formatCurrency(row.holding.quarterAccRevenue)}</span>
                        </div>
                        <div class="flex justify-between items-center py-3 border-b border-slate-100 bg-blue-50/50 px-3 rounded-lg mt-2 mb-4 border border-blue-100">
                            <div>
                                <span class="font-bold text-blue-800 block">Base de Presunção do Trimestre</span>
                                <span class="text-[10px] text-blue-600">Conforme percentuais definidos em lei sobre faturamento</span>
                            </div>
                            <span class="font-black text-blue-700 text-lg">${formatCurrency(row.holding.quarterBaseValue)}</span>
                        </div>

                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                <div>
                                    <div class="font-bold text-slate-700">IRPJ</div>
                                    <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.holding.quarterBaseValue)} × Alíq: ${formatPercent(row.holding.irpjRate)}</div>
                                </div>
                                <span class="font-bold text-red-600">${formatCurrency(row.holding.irpj)}</span>
                            </div>
                            ${row.holding.adicional > 0 ? `
                            <div class="flex justify-between items-center py-2 border-b border-slate-100 bg-red-50/30 px-2 -mx-2 rounded">
                                <div>
                                    <div class="font-bold text-slate-700">Adicional de IRPJ (10%)</div>
                                    <div class="text-[10px] text-slate-500">Incide sobre o valor da Base que excede R$ 60.000,00</div>
                                </div>
                                <span class="font-bold text-red-600">${formatCurrency(row.holding.adicional)}</span>
                            </div>
                            ` : `
                            <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                <div>
                                    <div class="font-bold text-slate-700">Adicional de IRPJ (10%)</div>
                                    <div class="text-[10px] text-slate-500">Isento (Base de presunção do trimestre não superou R$ 60k)</div>
                                </div>
                                <span class="font-bold text-slate-400">R$ 0,00</span>
                            </div>
                            `}
                            <div class="flex justify-between items-center py-2">
                                <div>
                                    <div class="font-bold text-slate-700">CSLL</div>
                                    <div class="text-[10px] text-slate-500">Base: ${formatCurrency(row.holding.quarterBaseValue)} × Alíq: ${formatPercent(row.holding.csllRate)}</div>
                                </div>
                                <span class="font-bold text-red-600">${formatCurrency(row.holding.csll)}</span>
                            </div>
                        </div>
                    `, 'fa-scale-balanced', 'bg-blue-100 text-blue-600');
                } else {
                     detailsHTML += `
                     <div class="p-6 mt-4 border border-dashed border-blue-200 bg-blue-50/50 rounded-xl flex items-center gap-4 shadow-sm mb-4">
                        <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-hourglass-half text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-blue-800">Mês de Formação de Caixa (Sem IRPJ/CSLL)</h4>
                            <p class="text-xs text-blue-600 mt-1 leading-relaxed">As empresas do Lucro Presumido recolhem impostos sobre o lucro trimestralmente. Neste mês você recolhe apenas os impostos incidentes sobre o faturamento. O lucro será apurado no fechamento do trimestre civil.</p>
                        </div>
                     </div>
                     `;
                }

                detailsHTML += summaryTotal('Soma de Impostos no Mês', row.holding.tax, 'bg-blue-900', 'text-white');
            }

            content.innerHTML = detailsHTML;

            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); }, 10);
        }

        function closeDetailModal() {
            const modal = document.getElementById('detailMonthModal');
            modal.classList.add('opacity-0'); modal.children[0].classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function openMonthlyReportModal() {
            const modal = document.getElementById('monthlyReportModal');
            const data = calculateData();
            const tbody = document.getElementById('monthlyTableBody');
            
            let html = '';
            data.monthlyData.forEach(row => {
                html += `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100 group">
                    <td class="px-4 py-3 col-sticky-left bg-white font-mono font-bold text-slate-600 border-r border-slate-100 group-hover:bg-slate-50 shadow-sm">${row.date}</td>
                    <td class="px-4 py-3 text-right font-medium text-slate-600 border-r border-slate-100 bg-slate-50/50">${formatCurrency(row.gross)}</td>
                    <td class="px-4 py-3 text-right font-bold text-red-700 bg-red-50/50 border-r border-red-100/50">${formatCurrency(row.aluguel.tax)}</td>
                    <td class="px-4 py-3 text-right font-bold text-blue-700 bg-blue-50/50">${formatCurrency(row.holding.tax)}</td>
                </tr>`;
            });
            tbody.innerHTML = html;

            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); }, 10);
        }

        function closeMonthlyReportModal() {
            const modal = document.getElementById('monthlyReportModal');
            modal.classList.add('opacity-0'); modal.children[0].classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            applyMasks();
            
            if(!checkInitModes()) {
                initAnnualRates();
            }
            
            // Força renderização inicial completa
            updateDashboard();
            renderRateTables();
            
            setupDynamicInputs(); 
        });

        // Ajusta layout ao rotacionar celular ou redimensionar janela
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                // No desktop, garante que a sidebar não fique presa oculta se foi fechada no mobile
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            } else {
                // No mobile, se o overlay estiver oculto, garante que a sidebar também esteja
                if (overlay.classList.contains('hidden')) {
                    sidebar.classList.add('-translate-x-full');
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                closeMonthlyReportModal();
                closeDetailModal();
                closeIrpfConfigModal();
                closeCloudLoadModal();
            }
        });

    </script>
</body>
</html>
